function Editor(W,ld,Mg,Yd,Ng){function Og(a,b){this.name=a;this.args=b}function qe(a){this.graph=new Utils.Manhattan;this.free=new Utils.SortedSet;this.render=a;this.sockets=[];this.pgraph=H(this.graph,a)}function z(a,b,c,d){this.type=a;this.table=b;this.id=c;this.fields=d||{};this.undo=null}function ya(a,b,c){this.id=a;this.type=b;this.dims=c}function Pg(a,b,c,d,e){this.id=a;this.type=b;this.dims=c;this.box=d;this.touchBox=e}function Wa(a,b,c){this.edge=a;this.min=b;this.max=c;this.found=!1}function Qg(a,
b,c){this.check=Rg;this.referenceItem=a;this.itemId=b;this.criteria=c;this.minDist=2E9;this.found=null}function Rg(a,b){if(a!=this.itemId&&this.criteria(b)){var c,d=this.referenceItem;c=b.x-d.x;d=b.y-d.y;c=Math.sqrt(c*c+d*d);c<this.minDist&&(this.found=a,this.minDist=c)}}function Sg(a,b,c,d){this.id=a;this.center=Utils.copyPoint(b);this.type=c;this.action=d;this.box=Utils.boxFromPoint(b.x,b.y,Config.SOCKET_TOUCH_RADIUS,Config.SOCKET_TOUCH_RADIUS)}function md(a,b,c,d){this.id=a;this.type=b;this.action=
c;this.name=d}function Kc(a){this.persistence=a;this.graph=new Utils.Manhattan;this.free=new Utils.SortedSet;this.selection=ua();this.nextId=1}function nd(){this.next=0;this.steps=[]}function ac(a,b,c,d,e){b=za(b,c,d);b.group=e;a.addItem(b)}function Xa(a,b,c,d,e,f){b=ma(b,c,d,e,f);a.addItem(b)}function od(a,b,c){b.type in pd||c.push({type:"item",text:n("MES_EXTERNAL_LINK")+"...",code:function(a,c){var f=P.editLink;if(f){var g=Utils.copyObject(S(b));f(b.id,g,a,c)}}})}function bc(a,b){if("header"==
b.role&&P.findReferences){var c=S(b).txt;c&&(a.push({type:"item",text:Yd("MES_FIND_REFERENCES"),code:function(){P.findReferences(c)}}),a.push({type:"separator"}))}}function Gb(a,b,c){var d=S(b);d.link&&(d=Utils.truncateText(d.link,Config.CONTEXT_ITEM_LENGTH+10),c.push({type:"item",text:d,code:function(){var c=b.id;x("followLink",[c]);c=D(a.storage,c);c=S(c);if(c.link){var d=P.followLink;d&&d(c.link)}}}),c.push({type:"separator"}))}function qd(a,b,c,d,e,f){var g=Utils.boxFromPoint(c,d,Config.GRIP,
Config.GRIP);c=Utils.boxFromPoint(c,d,Config.GRIP_TOUCH,Config.GRIP_TOUCH);b=new Pg(b,e,f,g,c);a.push(b)}function Lc(a,b,c,d){for(var e=0,f=c.length;e<f;){var g=c[e],h=g,k=0;ia()&&(k=h.name,k===Const.DRN_SIZE_R?h.name=Const.MIND_SIZE_R:k===Const.DRN_SIZE_L&&(h.name=Const.MIND_SIZE_L));qd(a,b,g.x,g.y,g.name,d);e++}}function Mc(a,b){if(a)for(var c=0,d=Object.keys(a),e=d.length;c<e;)b.push(a[d[c]]),c++}function rd(a,b,c){for(var d=0,e=b.length;d<e;){var f=b[d],g=1==a.getNode(f.id).flag1;f.marked!=g&&
(cc(c,f.id).fields.flag1=f.marked?1:0);d++}}function sd(a,b,c){if(!(F()||b.type in pd)){var d=Utils.copyObject(S(b));d.status?(delete d.status,a="MES_CLEAR_MARK"):(d.status="completed",a="MES_MARK_COMPLETED");c.push({type:"item",text:n(a),code:function(){td(b.id,d)}});c.push({type:"separator"})}}function ud(a,b){var c={type:"item",text:n(a.text),code:function(){Hb(a.action,a.itemId,a.type)}};a.image&&(c.image=a.image);b.push(c)}function vd(a,b,c){var d={type:"item",text:n({MES_ADD_LEFT_ITEM:"MES_PASTE_LEFT_ITEM",
MES_ADD_RIGHT_ITEM:"MES_PASTE_RIGHT_ITEM",MES_ADD_ITEM_ABOVE:"MES_PASTE_ITEM_ABOVE",MES_ADD_ITEM_BELOW:"MES_PASTE_ITEM_BELOW",MES_ADD_VER_CHILD:"MES_PASTE_VER_CHILD",MES_ADD_CHILD:"MES_PASTE_CHILD",MES_ADD_ITEM:"MES_PASTE_ITEM"}[a.text]),code:function(){wd(a.action,a.itemId,b)}};a.image&&(d.image=a.image);c.push(d)}function Zd(a,b,c,d){for(var e=b.graph,f=0,g=e.nodes,h=Object.keys(g),k=h.length;f<k;){var l=h[f],u=g[l];b=t(a.storage);d[l]=b;f++}f=0;g=e.nodes;h=Object.keys(g);for(k=h.length;f<k;)l=
h[f],u=g[l],b=d[l],Ya(c,b,u),f++;u=0;e=e.edges;f=Object.keys(e);for(g=f.length;u<g;)l=f[u],h=e[l],b=t(a.storage),d[l]=b,l=d[h.head],k=d[h.tail],h.isVertical?Aa(c,b,l,k,h.role):G(c,b,l,k,h.role),u++}function Ib(a,b,c,d){c={dirty:!1,commands:c};xd(c,"branch",Tg);xd(c,"address",Ug);for(var e=0,f=[],g=[],h=m.storage.graph,k=0,l=h.nodes,u=Object.keys(l),q=u.length;k<q;){var p=l[u[k]],e=p.type;"branch"===e?yd(f,p):"address"===e&&yd(g,p);k++}e=0;for(k=f.length;e<k;){l=f[e];u=0;q=g;for(p=q.length;u<p;){var r=
q[u];r.x>=l.x&&r.text==l.text&&(r.marked=!0,l.marked=!0);u++}e++}e={};rd(h,f,e);rd(h,g,e);$d(c,e);pb(c.commands,!1);c.dirty&&(Nc(),na(m));f=c=c.commands;c=a.steps.slice(0,a.next);b={before:b,commands:f,after:d,info:CallTrace.peek()};c.push(b);a.steps=c;a.next=c.length}function x(a,b){CallTrace.add(a,b)}function zd(a){var b;if(20180619<=m.storage.version&&"branch"==a.type){var c=a.content;c||(c=new Utils.Content("",""));if(!c.font){var c=Utils.copyObject(c),d=m.storage.font;(d=d||Za("font"))?(b=Utils.parseFontString(d),
d=b.size,b=b.family):(d=Config.FONT_SIZE,b=Config.FONT_FAMILY);d=Math.max(d,Config.BRANCH_HEADER_SIZE);c.font=Utils.buildFontString(!1,!0,d,b)}a.content=c}}function Ad(a){var b=a.storage.free;a=a.storage.selection;for(var c=[],d=[],e=[],f=0,g=Object.keys(a.ids),h=g.length;f<h;){var k=g[f];"green"==a.ids[k]?c.push(k):b.get(k)?d.push(k):e.push(k);f++}return{greens:c,frees:d,blues:e}}function oa(a,b,c,d){b=new md(b,d,c,"insert");a.push(b)}function ye(a,b,c,d,e){var f;if(f=b.isLine){var g=m.storage.graph;
f=g.getNode(b.head);g=g.getNode(b.tail);f=Oc(f)||Oc(g)?!0:!1;f=f||"bridge"!=b.role}f||(d=Jb(d,e[0],0,0),oa(a,b.id,d,c))}function dc(a,b,c){var d,e;"string"==typeof c?(d=c,(e=O[c])||Utils.throwError("transplant not found: "+c)):(d="no name",e=c);b=new md(b,"liana",e,d);a.push(b)}function M(a,b,c){qb(a,b,c,!0,!0)}function qb(a,b,c,d,e){if(0!==b.length){b=ec(a.storage,b);var f=pa(a),g=pa(a);if(d&&(g.selection=ua(),c))if("object"==typeof c){d=0;for(var h=c.length;d<h;)g.selection.add(c[d],!1),d++}else g.selection.add(c,
!0);$a(a,b,g,!1,e);Ib(a.undo,f,b,g)}}function ae(a,b,c){var d=[];"free"==T()&&d.push({type:"item",text:n("MES_PASTE"),code:function(){Bd(a,b,c)}});m.readonly||d.push({type:"item",text:n("MES_BACKGROUND"),code:function(a,b){var c=P.changeBackground;c&&c(a,b)}});return d}function Cd(){var a=[],b=m.storage.selection.block;if(b&&(b.oldIds={},b.top&&(a.push({type:"item",text:n("MES_COPY"),code:function(){rb(!0,!1)}}),!m.readonly))){a.push({type:"item",text:n("MES_CUT"),code:function(){rb(!0,!0)}});a.push({type:"item",
text:n("MES_DELETE"),code:function(){rb(!1,!0)}});a.push({type:"separator"});var b=fc(m),c=Object.keys(b);a.push({type:"item",text:n("MES_FORMAT"),code:function(a,b){Kb(a,b,c)}})}return a}function be(a){var b=0;a=a.storage.free.set;for(var c=Object.keys(a),d=c.length;b<d;){var e=a[c[b]],f=Drakon.fitItem(e,W);e.tb=f.tb;e.tb2=f.tb2;b++}}function Vg(a,b){var c=Dd(a.storage.graph,"type","branch").filter(function(a){return(a.content?a.content.txt:"")!=(b.content?b.content.txt:"")});c.sort(function(a,b){return a.x<
b.x?-1:a.x>b.x?1:0});return c.map(function(c){return Wg(a,b.id,c)})}function Xg(a,b,c,d,e,f){b.h0x=Config.FREE_WIDTH+20;b.h0y=Config.FREE_HEIGHT+40;X(a,f,c,"callout",d,e,Config.FREE_WIDTH,Config.FREE_HEIGHT,b)}function Yg(a,b,c,d,e,f){X(a,f,c,"f_circle",d,e,Config.FREE_WIDTH,Config.FREE_WIDTH,b)}function Zg(a,b,c,d,e,f){X(a,f,c,"f_cloud",d,e,Config.FREE_WIDTH,Config.FREE_WIDTH/2,b)}function $g(a,b,c,d,e,f){X(a,f,c,"f_db",d,e,Config.FREE_WIDTH,Config.FREE_WIDTH,b)}function ce(a,b){return[{type:"item",
text:n("MES_ADD_LINE"),image:"expand.png",code:function(){ze(a,b.id)}}]}function Ae(a,b){var c=[];c.push({type:"item",text:n("MES_FORMAT"),code:function(a,c){Kb(a,c,b)}});return c}function ah(a,b,c){var d=[];d.push({type:"item",text:n("MES_COPY"),code:function(){Pa(a,b,!0,!1)}});m.readonly||(d.push({type:"item",text:n("MES_CUT"),code:function(){Pa(a,b,!0,!0)}}),d.push({type:"separator"}),d.push({type:"item",text:n("MES_DELETE"),code:function(){Lb(a,b)}}),d.push({type:"separator"}),d.push({type:"item",
text:n("MES_FORMAT"),code:function(a,b){Kb(a,b,c)}}));return d}function Be(a,b){if(m.readonly){var c=a.storage.graph,d=[];bc(d,b);Gb(a,b,d);gc(c,b)&&d.push({type:"item",text:n("MES_COPY"),code:function(){hc(a,b.id,!1)}});d.push({type:"item",text:n("MES_COPY_TEXT"),code:function(){Pc(a,b.content)}});return d}return bh(a,b)}function bh(a,b){var c=0,c=0,d=a.storage.graph,e=[];bc(e,b);sd(a,b,e);Gb(a,b,e);c=Qc(a,b);gc(d,b)&&(e.push({type:"item",text:n("MES_COPY"),code:function(){hc(a,b.id,!1)}}),c&&e.push({type:"item",
text:n("MES_CUT"),code:function(){hc(a,b.id,!0)}}),"case"==T()?"case"==b.type&&e.push({type:"item",text:n("MES_PASTE"),code:function(){Rc(a,b.id)}}):"branch"!=T()||"branch"!=b.type||"end"==U(d,b.id).type||e.push({type:"item",text:n("MES_PASTE"),code:function(){Ed(a,b.id)}}),e.push({type:"separator"}));c&&(e.push({type:"item",text:n("MES_DELETE"),code:function(){Ba(a,b.id)}}),e.push({type:"separator"}));e.push({type:"item",text:n("MES_COPY_TEXT"),code:function(){Pc(a,b.content)}});"text"==T()&&e.push({type:"item",
text:n("MES_PASTE_TEXT"),code:function(){Sc(a,b.id)}});c=b.type;"address"!==c&&(Tc(b)&&e.push({type:"item",text:n("MES_CHANGE_UPPER"),code:function(){Uc(b.id)}}),e.push({type:"item",text:n("MES_CHANGE_TEXT"),code:function(){Ka(b.id)}}));c=b.type;"question"===c?(e.push({type:"item",text:n("MES_SWAP_YES_NO"),code:function(){var c=b.id;x("swap 'yes' and 'no'",[c]);var d;d=a.storage.graph.getItem(c).flag1?0:1;c=[new z("update","nodes",c,{flag1:d})];qb(a,c,null,!1,!0)}}),Ng&&(e.push({type:"separator"}),
e.push({type:"item",text:n("MES_CHANGE_YES_NO"),code:function(){var a=P.changeYesNo;a&&a()}}))):"case"===c?e.push({type:"item",text:n("MES_INSERT_CASE"),image:"case.png",code:function(){V(a,b.id,"case")}}):"address"===c?e=e.concat(Vg(a,b)):"branch"===c&&"end"!=U(d,b.id).type&&(e.push(Ce(a,b)),ch(d,b)&&e.push(dh(a,b)));"header"===b.role&&(ic(a.storage.graph,"params")||e.push({type:"item",text:n("MES_ADD_PARAMS"),image:"params-1.png",code:function(){V(a,null,"params")}}),re(a.storage.graph)?e.push({type:"item",
text:n("MES_TRANS_TO_PRIM"),image:"primitive.png",code:function(){jc(a)}}):e.push({type:"item",text:n("MES_TRANS_TO_SILH"),image:"silhouette.png",code:function(){Fd(a)}}));od(a,b,e);e.push({type:"separator"});e.push({type:"item",text:n("MES_FORMAT"),code:function(a,c){Kb(a,c,[b.id])}});return e}function De(a,b){var c=a.storage.graph,d=[];"block"==T()&&d.push({type:"item",text:n("MES_PASTE"),code:function(){Mb(a,b.id)}},{type:"separator"});var e=[{type:"item",text:n("BUT_ACTION"),image:"action.png",
code:function(){V(a,b.id,"action")}},{type:"item",text:n("BUT_QUESTION"),image:"question.png",code:function(){V(a,b.id,"question")}},{type:"item",text:n("BUT_SELECT"),image:"select.png",code:function(){V(a,b.id,"select")}},{type:"item",text:n("BUT_FOREACH"),image:"foreach.png",code:function(){V(a,b.id,"foreach")}},{type:"item",text:n("BUT_INSERTION"),image:"insertion.png",code:function(){V(a,b.id,"insertion")}},{type:"item",text:n("BUT_COMMENT"),image:"comment.png",code:function(){V(a,b.id,"comment")}}],
d=d.concat(e);Nb(c,b)&&d.push(ab(a,b));return d}function eh(a,b,c,d,e,f){b.txt="Text";b.lineThickness=0;b.align="center";b.padding=0;X(a,f,c,"f_label",d,e,Config.FREE_WIDTH,Config.FREE_HEIGHT-Config.SIZE_SNAP,b)}function Ee(a,b,c){var d=new Utils.Manhattan;b=Y(1,a,"loopbegin",b);a=Y(2,a,"loopend",c);c=Math.max(b.w,a.w);b.w=c;a.w=c;a.y=b.h+a.h+3*Config.METRE;d.addItem(b);d.addItem(a);d.addItem(ma(3,!0,1,2,"down"));return{graph:d,first:1,last:2}}function Fe(a,b,c){var d=5;a=Y(1,a,"question",b);a.flag1=
c;b=a.w+2*Config.METRE;var e=a.h+4*Config.METRE;c=za(2,b,0);b=za(3,b,e);var e=za(4,0,e),f=new Utils.Manhattan;f.addItem(a);f.addItem(c);f.addItem(b);f.addItem(e);f.addItem(ma(d++,!1,a.id,c.id,null));f.addItem(ma(d++,!0,c.id,b.id,"down"));f.addItem(ma(d++,!1,e.id,b.id,"left"));f.addItem(ma(d++,!0,a.id,e.id,"down"));return{graph:f,first:a.id,last:e.id}}function Ge(a,b,c){var d,e=c.length,f=2,g=0,h=[];for(d=0;d<e;){var k=Y(f,a,"case",c[d]);k.group=1;f+=10;g=Math.max(g,k.h);h.push(k);d++}c=new Utils.Manhattan;
d=Y(1,a,"select",b);d.group=1;a=d.h+Config.METRE;b=a+Config.METRE+g;var k=b+g+3*Config.METRE,l=h[0],u=Math.max(d.w,l.w);l.y=b;l.h=g;l.w=u;d.w=u;c.addItem(d);c.addItem(l);l=3;u=4;ac(c,l,0,a,1);ac(c,u,0,k,null);Xa(c,5,!0,1,l,null);Xa(c,6,!0,l,2,null);Xa(c,7,!0,2,u,"down");var m=d.w+Config.METRE;for(d=1;d<e;){var p=h[d],m=m+p.w;p.h=g;p.y=b;p.x=m;var r=p.id+1,y=p.id+2;ac(c,r,m,a,1);ac(c,y,m,k,null);c.addItem(p);Xa(c,f++,!1,l,r,null);Xa(c,f++,!0,r,p.id,null);Xa(c,f++,!0,p.id,y,"down");Xa(c,f++,!1,u,y,
"left");l=r;u=y;m+=p.w+Config.METRE;d++}return{graph:c,first:1,last:4}}function He(a,b,c){var d=new Utils.Manhattan;a=Y(1,a,b,c);d.addItem(a);return{graph:d,first:1,last:1}}function Ie(a,b){var c=D(a.storage,b),d=[];sd(a,c,d);Gb(a,c,d);d.push({type:"item",text:n("MES_COPY"),code:function(){Pa(a,[b],!0,!1)}});m.readonly||(d.push({type:"item",text:n("MES_CUT"),code:function(){Pa(a,[b],!0,!0)}}),d.push({type:"separator"}),d.push({type:"item",text:n("MES_DELETE"),code:function(){Lb(a,[c.id])}}));d.push({type:"separator"});
d.push({type:"item",text:n("MES_COPY_TEXT"),code:function(){Pc(a,c.content)}});"text"!=T()||m.readonly||d.push({type:"item",text:n("MES_PASTE_TEXT"),code:function(){Sc(a,c.id)}});Tc(c)&&d.push({type:"item",text:n("MES_CHANGE_UPPER"),code:function(){Uc(c.id)}});d.push({type:"item",text:n("MES_CHANGE_TEXT"),code:function(){Ka(c.id)}});m.readonly||(od(a,c,d),d.push({type:"separator"}),d.push({type:"item",text:n("MES_TO_FRONT"),code:function(){Je(a,b)}}),d.push({type:"item",text:n("MES_TO_BACK"),code:function(){Ke(a,
b)}}),d.push({type:"separator"}),d.push({type:"item",text:n("MES_FORMAT"),code:function(a,b){Kb(a,b,[c.id])}}));return d}function Le(a,b){var c=0,d=0,e=a.storage.graph.getItem(b),d=a.storage.graph,f=null;if(m.readonly)"junction"==e.type||e.isLine||(f=Be(a,e));else if(c=e.type,"horizontal"===c)if(Utils.canInsertInHorizontal(d,e))f=De(a,e),d=ce(a,e),f.push({type:"separator"}),f=f.concat(d);else{var g=de(d,e),f=[];if(g)if(d=g.type,"case"===d)"case"==T()&&f.push({type:"item",text:n("MES_PASTE"),code:function(){Rc(a,
g.id)}}),f.push(fh(a,g));else{if("branch"!==d)throw"Unexpected switch value: "+d;"branch"==T()&&f.push({type:"item",text:n("MES_PASTE"),code:function(){Ed(a,g.id)}});f.push(Ce(a,g))}else"parallel"==e.role&&f.push({type:"item",text:n("MES_NEW_PATH"),image:"par.png",code:function(){Gd(a,e.id)}},{type:"item",text:n("MES_DELETE_PATH"),code:function(){Ob(a,e.id)}})}else"junction"===c?Me(d,e)?f=[{type:"item",text:n("MES_NEW_PATH"),image:"par.png",code:function(){Ne(a,e.id)}},{type:"item",text:n("MES_DELETE_PATH"),
code:function(){Ob(a,e.left)}}]:"junction"==e.type&&e.left&&e.right&&"parallel"==d.getEdge(e.left).role?f=[{type:"item",text:n("MES_NEW_PATH"),image:"par.png",code:function(){Gd(a,e.right)}},{type:"item",text:n("MES_DELETE_PATH"),code:function(){Ob(a,e.left)}}]:e.left?(c=d.getEdge(e.left),gh(d,c)?f=ce(a,c):e.up?(c=d.getEdge(e.up),Nb(d,c)&&(f=[ab(a,c)])):e.down&&(c=d.getEdge(e.down),Nb(d,c)&&(f=[ab(a,c)]))):e.up?(c=d.getEdge(e.up),Nb(d,c)&&(f=[ab(a,c)])):e.down&&(c=d.getEdge(e.down),Nb(d,c)&&(f=[ab(a,
c)])):"vertical"===c?sb(e)&&(f=De(a,e)):f=Be(a,e);return f}function Oe(a,b){var c=a.storage.graph.getItem(b);if(c.isLine||"junction"==c.type){c=[];if(!a.readonly){var d=a.storage.graph.getItem(b),d=ee(a,d);if(0<d.length)for(var e=0,f=d.length;e<f;){var g=d[e];ud(g,c);e++}if(0<d.length&&"mind"==T()&&(e=Z("mind")))for(var f=0,h=d.length;f<h;)g=d[f],vd(g,e,c),f++}return c}return hh(a,b)}function hh(a,b){var c=a.storage.graph.getItem(b),d=[];bc(d,c);a.readonly||sd(a,c,d);Gb(a,c,d);if(!a.readonly){var e=
ee(a,c);if(0<e.length){for(var f=0,g=e,h=g.length;f<h;)ud(g[f],d),f++;d.push({type:"separator"})}}d.push({type:"item",text:n("MES_COPY"),code:function(){Pb(c.id,!1)}});if(!a.readonly){var k=Pe(c);k&&d.push({type:"item",text:n("MES_CUT"),code:function(){Pb(c.id,!0)}});0<e.length&&"mind"==T()&&d.push({type:"item",text:n("MES_PASTE"),code:function(a,b){var c=e,d=[],f=Z("mind");if(f){for(var g=0,h=c.length;g<h;)vd(c[g],f,d),g++;(c=P.showContextMenu)&&c(a,b-30,d)}}});k&&(d.push({type:"separator"}),d.push({type:"item",
text:n("MES_DELETE"),code:function(){Hb(k,b,null)}}))}d.push({type:"separator"});d.push({type:"item",text:n("MES_COPY_TEXT"),code:function(){Pc(a,c.content)}});"text"==T()&&d.push({type:"item",text:n("MES_PASTE_TEXT"),code:function(){Sc(a,c.id)}});Tc(c)&&d.push({type:"item",text:n("MES_CHANGE_UPPER"),code:function(){Uc(c.id)}});d.push({type:"item",text:n("MES_CHANGE_TEXT"),code:function(){Ka(c.id)}});od(a,c,d);a.readonly||(d.push({type:"item",text:n("MES_TURN_INTO"),code:function(a,b){var d=c.id,
e=m.storage.graph.getItem(d),f=[];f.push({image:"rectangle.png",text:"BUT_RECTANGLE",type:"action"});f.push({image:"rounded.png",text:"BUT_ROUNDED",type:"raction"});f.push({image:"collection.png",text:"BUT_COLLECTION",type:"collection"});f.push({image:"f_begin.png",text:"BUT_FBEGIN",type:"beginend"});f.push({image:"insertion.png",text:"BUT_INSERTION",type:"insertion"});var g;for(g=0;g<f.length;){if(f[g].type==e.type){f.splice(g,1);break}g++}g=[];for(var h=0,k=f.length;h<k;)e=ih(d,f[h]),g.push(e),
h++;(d=P.showContextMenu)&&d(a,b-30,g)}}),d.push({type:"separator"}),d.push({type:"item",text:n("MES_FORMAT"),code:function(a,b){Kb(a,b,[c.id])}}));return d}function jh(a,b,c,d,e,f,g){b.subtype=g;b.lineThickness=2;g=ea.newMore(b);X(a,f,c,"f_more",d,e,g.w,g.h,b)}function I(a,b,c){var d=0;b=Object.keys(b);for(var e=b.length;d<e;){var f=b[d],g=a.graph.getItem(f);f in c?(f=c[f].fields,f.x=g.x,f.y=g.y):(g=new z("update","nodes",f,{x:g.x,y:g.y}),c[f]=g);d++}}function kh(a,b,c,d,e,f){b.h0x=20;X(a,f,c,"f_ptr_left",
d,e,Config.FREE_WIDTH,Config.FREE_HEIGHT,b)}function lh(a,b,c,d,e,f){b.h0x=20;X(a,f,c,"f_ptr_right",d,e,Config.FREE_WIDTH,Config.FREE_HEIGHT,b)}function mh(a,b,c,d,e,f){b.radius=8;X(a,f,c,"f_rounded",d,e,Config.FREE_WIDTH,Config.FREE_HEIGHT,b)}function nh(a,b,c,d,e,f){X(a,f,c,"shelf",d,e,Config.FREE_WIDTH,2*Config.FREE_HEIGHT,b)}function Nc(){var a=m;be(a);for(var b=0,c=a.storage.graph.nodes,d=Object.keys(c),e=d.length;b<e;){var f=d[b],g=c[f],f=Drakon.fitItem(g,W);g.tb=f.tb;g.tb2=f.tb2;b++}a=a.storage.free;
b=0;c=a.list;for(d=c.length;b<d;)f=c[b],e=a.get(f),f=Drakon.fitItem(e,W),e.tb=f.tb,e.tb2=f.tb2,b++}function ec(a,b){for(var c=Vc(b),d=0,e=c.length;d<e;){var f=a,g=c[d],h=0,k=0;if("insert"===g.type)k=g.table,"nodes"===k?g.fields.isLine=!1:"edges"===k&&(g.fields.isLine=!0);else{var k={},h=void 0,l=f.graph,u=f.free,h=g.table;if("nodes"===h||"edges"===h)if(h=l.getItem(g.id),"update"===g.type)Hd(g.fields,h,k);else for(f=0,l=Object.keys(h),u=l.length;f<u;){var m=l[f],p=h[m];k[m]=p;f++}else if("free"===
h)if(h=u.get(g.id),"update"===g.type)Hd(g.fields,h,k);else for(f=0,l=Object.keys(h),u=l.length;f<u;)m=l[f],p=h[m],k[m]=p,f++;else{if("diagrams"!==h)throw"Unexpected switch value: "+h;Hd(g.fields,f,k)}g.undo=k}d++}return c}function kc(a,b){if(lc(a.storage.graph)+b>Config.MAX_ICONS){var c=P.showWarningPopup;c&&c("Cannot add more icons to the diagram");return!1}return!0}function Qe(a){return a?(a=D(m.storage,a))&&!a.isLine&&"junction"!==a.type?!0:!1:!1}function gc(a,b){var c=0;if(b.isLine)return!1;c=
b.type;return"beginend"===c||"end"===c||"address"===c||"loopend"===c||"junction"===c?!1:"branch"===c?!0:"params"!=b.role}function Re(a,b,c){b=a.getEdge(b);b=a.getTail(b);if(Se(b))return!0;b=a.getEdge(b.down);return Qa(a,b.tail,c)}function Qc(a,b){var c=0,d=a.storage.graph;if(b.isLine)return!1;c=b.type;if("junction"===c||"address"===c||"end"===c||"beginend"===c)return!1;if("question"===c)return Re(d,b.right,{})?(c=d.getNodeRight(b),c=d.getNode(c),d=Se(c)?!0:ja(d,c,{})):d=!1,d;if("select"===c)return d=
Te(d,b,{})?Ue(d,b,{}):!1,d;if("case"===c)a:{var c={},e=d.getNodeUp(b),e=d.getNode(e);if(e.left)if(e.right){if(e=d.getNodeDown(b),c=Qa(d,e,c)){c={};d=ja(d,b,c);break a}}else if(e=d.getNodeLeft(e),d.getNode(e).left&&(e=d.getNodeDown(b),c=Qa(d,e,c))){c={};d=ja(d,b,c);break a}d=!1}else"branch"===c?(c=d.getNodeUp(b),c=d.getNode(c),c.left?(e=d.getEdge(c.left),d="rarrow"===e.role?!1:c.right?!0:d.getNode(e.head).up?!1:!0):d=!1):d=!0;return d}function Qa(a,b,c){var d=0;b=a.getNode(b);if(b.down){var e=a.getNodeDown(b),
d=b.type;if("junction"===d){if(!b.left||b.left in c)return Qa(a,e,c);c=a.getNodeLeft(b);return"question"===a.getNode(c).type?!0:!1}return"question"===d?(d=Qa(a,e,c))?Re(a,b.right,c):!1:"select"===d?(d=Qa(a,e,c))?Te(a,b,c):!1:Qa(a,e,c)}b.right&&(c[b.right]=!0);return!0}function Te(a,b,c){b=Wc(a,b.id);var d=b.length,e;for(e=1;;){if(!(e<d))return!0;var f=a.getNodeDown(b[e]);if(!Qa(a,f,c))return!1;e++}}function Ve(a){if(a.isLine)return!1;a=a.type;return"duration"==a||"junction"==a||"case"==a||"branch"==
a||"address"==a?!1:!0}function tb(a,b){if(b){var c=a.getItem(b);return c.isLine?c.isVertical?"down"!=c.role||We(a,c)||oh(a,c)?!1:!0:Xe(a,c)||Ye(a,c)||Ze(a,c)?!0:!1:"address"===c.type?(c=fe(a,b),"beginend"===c.type?c=!0:(c=a.getNodeDown(c),c="branch"===a.getNode(c).type?!0:!1),c?!1:!0):"junction"===c.type?"left-up"==v(c)&&ge(a,c)?!0:c.up?tb(a,c.up):!1:c.up?tb(a,c.up):!1}return!1}function Kb(a,b,c){var d=P.changeFormat;d&&d(a,b,c)}function bb(a,b,c,d){a.edge==b&&(a.found=!0,a.min=Math.min(a.min,c),
a.max=Math.max(a.max,d))}function $e(a,b,c,d,e,f,g){for(var h=a.graph,k=c+Config.METRE,l=Math.floor(b+Config.METRE/2),u=d-Config.METRE+1,m=d+1;;){b+=Config.SNAP;for(var p=new Utils.Box(l,u,b,m),r=0,y=h.items,t=Object.keys(y),n=t.length;r<n;){var x=y[t[r]],w;if(x.isLine){if(w=x.tail,x.isVertical&&Utils.boxesIntersect(p,x.box)){a.moveRight(w,Config.SNAP,g);break}}else if(w=x.id,Utils.boxesIntersect(p,x.box)){a.moveRight(w,Config.SNAP,g);break}r++}if(b>=k)break}Xc(a,c,d,e.y+Config.METRE,g);if(e.y>f.y){k=
f.x;d=f.y;l=f.id;f=a.graph;e=e.y+Config.METRE;c=Math.floor(d+Config.METRE/2);b=new Utils.Box(k-1,c,k+1,e);h=k;u=0;m=f.nodes;p=Object.keys(m);for(r=p.length;u<r;)y=m[p[u]],(y.x>k||"duration"==y.type)&&Utils.boxesIntersect(y.box,b)&&(y=y.box.left-Config.METRE,y<h&&(h=y)),u++;h!=k&&a.moveRight(l,h-k,g);k=h-1;for(l=h+1;;){d+=Config.METRE;if(d>=e)break;u=new Utils.Box(k,c,l,d);m=0;p=f.items;r=Object.keys(p);for(y=r.length;m<y;){b=p[r[m]];if(Utils.boxesIntersect(u,b.box)&&!b.isVertical){if(b.isLine){if("lstick"!=
b.role){u=a;m=h;p=g;r=u.graph;b=b.tail;for(y=void 0;;){y=r.getNode(b);if(!y.right)break;b=r.getNodeRight(y)}u.moveRight(b,m-y.box.right-Config.METRE,p)}break}if(b.x!=h){af(a,b,h,g);break}}m++}}}}function va(a){return{block:"clip-block","case":"clip-case",branch:"clip-branch",duration:"clip-duration",mind:"mind-clip"}[a]}function mc(a){for(var b={},c=0,d=Object.keys(a),e=d.length;c<e;){for(var f=d[c],g={},h=0,k=a[f],l=Object.keys(k),u=l.length;h<u;){var m=l[h],p=k[m];null!==p&&(g[m]=p);h++}b[f]=g;
c++}return b}function bf(a,b){var c=cf(a,b);M(a,c.commandList,null)}function cf(a,b){x("remove line",[b]);var c={},d={},e=H(a.storage.graph,a.render),f=e.graph,g=f.getEdge(b),h=f.getHead(g),k=f.getTail(g),l=k.y-h.y,g=f.getEdge(h.left),f=f.getEdge(k.right);e.deletePhysicalItem(h.left);e.deletePhysicalItem(b);e.deletePhysicalItem(h.id);e.rebuildCache();e.moveDown(k.id,-l,c);delete c[k.id];I(e,c,d);c=Utils.objectValues(d);w(c,g.id);w(c,b);w(c,f.id);ca(c,h.id);ca(c,k.id);h=t(a.storage);G(c,h,g.head,f.tail,
null);return{commandList:c}}function $d(a,b){var c=Utils.objectValues(b);0!=c.length&&(a.dirty=!0,c=ec(m.storage,c),Yc(m,c,!1),a.commands=a.commands.concat(c))}function ub(){var a=P.commandDone;a&&a()}function E(a,b,c,d,e){a=t(a.storage);G(b,a,c,d,e)}function C(a,b,c,d,e){a=t(a.storage);Aa(b,a,c,d,e);return a}function df(a,b){var c=null;if(a){for(var d=0,e=Utils.sortLinkedList(a,"next"),f=e.length;d<f;){var g=e[d];b.add(g.id,g);d++}Object.keys(a).length!=b.list.length&&(c="ERR_FREE_ORDER")}return c}
function rb(a,b){x("copy block",[a,b]);var c=null,d=null,e=nc(m.storage.selection).block;if(e&&e.top){for(var f=m.storage.graph,g={},h=0,k=Object.keys(e.nodes),l=k.length;h<l;){var u=f.getNode(k[h]);Utils.addNotNilToSet(g,u.left);Utils.addNotNilToSet(g,u.up);Utils.addNotNilToSet(g,u.right);Utils.addNotNilToSet(g,u.down);h++}k=f.getNode(e.top);h=f.getNode(e.bottom);delete g[k.up];if(cb(f,h)){c=e.nodes;l=h;for(d=[];;){d.push(l.id);if(!l.right)break;l=f.getNodeRight(l);if(!(l in c))break;l=f.getNode(l)}c=
f.getNode(d[d.length-1]);delete g[h.left];c.right&&delete g[c.right]}else delete g[h.down];l={graph:ef(f,e.nodes,g,e.top),first:e.top,last:e.bottom};if(d){for(var u=d,q=l.graph,p={},r=q.getMaxId()+1,y=null,t=0,n=u.length;t<n;){var w=u[t],K=q.getNode(w),v=q.getNodeUpEx(K),I=q.getNodeUpEx(v),da=K.x,H=K.y;q.removeItem(v.up);q.removeItem(v.down);K.right&&q.removeItem(K.right);q.removeItem(K.id);q.removeItem(v.id);p[w]=r;w=za(r++,da,H);q.addItem(w);q.addItem(ma(r++,!0,I.id,w.id,"down"));y&&q.addItem(ma(r++,
!1,y.id,w.id,"left"));y=w;t++}l.last=p[l.last]}b&&(x("delete subgraph",[e.top,e.bottom]),p=null,d?(g[k.up]=!0,delete e.nodes[h.id],delete g[h.up],p=f.getNodeUp(h),delete e.nodes[p],c.right&&(g[c.right]=!0)):(g[k.up]=!0,g[h.down]=!0),u=[],Qb(u,e.nodes,g),q=null,d?(d=f.getNodeUp(k),C(m,u,d,p,"down",null),c.right&&(f=f.getNodeRight(c),E(m,u,h.id,f,"sil_floor",null),delete g[c.right])):(d=f.getNodeUp(k),g=f.getNodeDown(h),f=f.getEdge(h.down).role,q=C(m,u,d,g,f,null)),Rb(m,u,q));a&&(x("copy subgraph",
[e.top,e.bottom]),wa("block",l),m.readonly||ka("clip-block"));ub()}}function yd(a,b){var c=S(b).txt||"";c&&a.push({id:b.id,x:b.x,text:c,marked:!1})}function Pa(a,b,c,d){var e=a.storage.free;if(c){c=[];for(var f=Utils.listToSet(b),g=0,h=e.list,k=h.length;g<k;){var l=h[g];l in f&&c.push({id:l,next:""});g++}ff(c);f=[];g=0;for(h=c.length;g<h;)k=c[g],l=e.get(k.id),l=La(l),l.next=k.next,f.push(l),g++;wa("free",{items:f})}d&&Lb(a,b)}function ef(a,b,c,d){b=gf(a,b,c);a=a.getNode(d);Zc(b,-a.x,-a.y);return b}
function gf(a,b,c){for(var d=new Utils.Manhattan,e=0,f=Object.keys(b),g=f.length;e<g;)b=f[e],b=a.getNode(b),b=Utils.copyObject(b),b.left=null,b.up=null,b.right=null,b.down=null,d.addItem(b),e++;e=0;c=Object.keys(c);for(f=c.length;e<f;)b=c[e],b=a.getEdge(b),b=Utils.copyObject(b),d.addItem(b),e++;return d}function Pb(a,b){var c=Mind.copySubtree(m.storage.graph,a);wa("mind",c);b&&hf(a);ka("mind-clip")}function hc(a,b,c){var d=0,e=null,f="block",e=a.storage.graph,g=a.render,h=e.getItem(b);if(gc(e,h))if(d=
h.type,"question"===d){if(e=Fe(g,h.content,h.flag1))wa(f,e),m.readonly||(c&&Ba(a,b),(a=va(f))&&ka(a))}else if("select"===d){for(var d=[],k=e.getNodeDown(h);;){var k=e.getNode(k),l=e.getNodeDown(k),l=e.getNode(l);d.push(l.content);if(!k.right)break;k=e.getNodeRight(k)}if(e=Ge(g,h.content,d))wa(f,e),m.readonly||(c&&Ba(a,b),(a=va(f))&&ka(a))}else if("loopbegin"===d){if(d=Drakon.findEndLoop(e,h),e=e.getNode(d),e=Ee(g,h.content,e.content))wa(f,e),m.readonly||(c&&Ba(a,b),(a=va(f))&&ka(a))}else if("case"===
d)e={content:h.content},f="case",e&&(wa(f,e),m.readonly||(c&&Ba(a,b),(a=va(f))&&ka(a)));else if("branch"===d){if(f=Id(e,b)){e=ef(e,f.nodes,f.edges,f.top);h=0;d=Object.keys(f.nodes);for(k=d.length;h<k;){g=e.getNode(d[h]);if("end"==g.type){h=e.getNode(f.top);h=e.getNodeDownEx(h);g.type="address";g.w=h.w;g.h=h.h;g.content=Utils.copyObject(h.content);g.y+=g.h;h=za("jun01",g.x,g.y+g.h+Config.METRE);e.addItem(h);Xa(e,"line01",!0,g.id,"jun01",null);f.bottom="jun01";f.rBottom="jun01";break}h++}e={graph:e,
top:f.top,bottom:f.bottom,rBottom:f.rBottom}}else e=null;e&&(f="branch",e&&(wa(f,e),m.readonly||(c&&Ba(a,b),(a=va(f))&&ka(a))))}else"duration"===d?(e=h.content,f="duration",e&&(wa(f,e),m.readonly||(c&&Ba(a,b),(a=va(f))&&ka(a)))):"params"!=h.role&&(e=He(g,h.type,h.content))&&(wa(f,e),m.readonly||(c&&Ba(a,b),(a=va(f))&&ka(a)))}function nc(a){return a&&a.ids?Utils.copyObjectDeep(a):ua()}function pa(a){return{origin:null,selection:nc(a.storage.selection)}}function La(a){var b={id:a.id,type:a.type,isLine:a.isLine,
isVertical:a.isVertical,x:a.x,y:a.y,w:a.w,h:a.h,a:a.a,b:a.b,content:a.content,head:a.head,tail:a.tail,flag1:a.flag1,role:a.role,group:a.group,tb:a.tb,free:a.free,next:a.next};a.tb2&&(b.tb2=a.tb2);return b}function Pc(a,b){wa("text",{content:b})}function wa(a,b){var c=P.copyToClipboard;c&&c(a,b)}function ab(a,b){return{type:"item",text:n("MES_REMOVE_LINE"),image:"collapse.png",code:function(){bf(a,b.id)}}}function jf(a,b,c,d){var e=b.graph,f={},g={};qa(b,d,0,f);var h=e.getEdge(c),k=e.getTail(h);c=
e.getHead(h);var l=e.getEdge(d),u=e.getTail(l);d=Q(e,u.id,k.id);var m=d.x,p=u.box.top-Config.METRE;$e(b,u.x,m,p,d,k,f);$c(c)&&d.y>c.y&&b.moveDown(c.id,d.y-c.y,f);I(b,f,g);b=Utils.objectValues(g);la(a,e,h,b);w(b,l.id);g=fa(a,e,l.head,l.tail,p,b);h=t(a.storage);e=t(a.storage);f=t(a.storage);N(b,e,m,p);G(b,h,g,e,"arrow");$c(c)?(Ca(b,"nodes",c.id,{x:m}),Aa(b,f,e,c.id,null)):(p=t(a.storage),g=t(a.storage),h=t(a.storage),a=t(a.storage),N(b,p,m,d.y),N(b,h,c.x,d.y),Aa(b,f,e,p,null),G(b,g,h,p,"right"),vb(b,
a,c.id,h));return b}function kf(a){for(var b=new Utils.Manhattan,c=0,d=a.nodes,e=Object.keys(d),f=e.length;c<f;){var g=e[c];b.addItem(d[g]);c++}c=0;a=a.edges;d=Object.keys(a);for(e=d.length;c<e;)g=d[c],b.addItem(a[g]),c++;return b}function lf(a){a=J(a);var b=Za("font"),b=b?Utils.parseFontString(b).family:Config.FONT_FAMILY,b=Utils.buildFontString(!1,!0,Config.HEADER_SIZE,b);a.font=b;a=Y(1,W,"duration",a);a.type="beginend";a.w=Math.max(Config.DEF_ICON_WIDTH_S,a.w);return a}function Ce(a,b){return{type:"item",
text:n("MES_INSERT_BRANCH"),image:"branch.png",code:function(){V(a,b.id,"branch")}}}function fh(a,b){return{type:"item",text:n("MES_INSERT_CASE"),image:"case.png",code:function(){V(a,b.id,"case")}}}function dh(a,b){return{type:"item",text:n("MES_INSERT_END_BRANCH"),image:"end.png",code:function(){V(a,b.id,"end_branch")}}}function mf(a,b,c,d){var e=D(a.storage,b),f=ea.getLinkHandle(e);if(f){a=f.link;var g=Utils.boxFromPoint(f.x,f.y,Config.GRIP_TOUCH,Config.GRIP_TOUCH);return Utils.hitBox(g,c,d)?(b=
new ya(b,Const.LINK,null),b.data=a,b):"insertion"===e.type&&nf(e,c,d)?(b=f?new ya(b,Const.LINK,null):new ya(b,Const.SUB,null),b.data=a,b):new ya(b,Const.DRN_MOVE,null)}a=e.content?e.content.txt:void 0;return"insertion"===e.type&&nf(e,c,d)?(b=f?new ya(b,Const.LINK,null):new ya(b,Const.SUB,null),b.data=a,b):new ya(b,Const.DRN_MOVE,null)}function H(a,b){var c;c=ia()?Mind.getSoftExpanders():{horizontal:ph,vertical:qh};return new PhysicalGraph(ea,a,b,c)}function ua(){var a=ia();return new Drakon.Selection(a)}
function of(a){var b=new Mind.ME;b.graph(m.storage.graph);b.itemId(a);b.render(m.render);b.nextId(m.storage.nextId);b.items(ea);return b}function Sb(a,b,c){c.edges[b.up]=!0;c.nodes[b.id]=!0;b=a.getNodeUp(b);b=a.getNode(b);c.edges[b.left]=!0;c.nodes[b.id]=!0;b=a.getNodeLeft(b);var d=a.getNode(b);b in c.nodes||L(a,d,c)}function Lb(a,b){x("delete free items",b);var c=a.storage.free;b=Utils.listToSet(b);var d=c.list.filter(function(a){return!(a in b)}).map(function(a){return{id:a,next:""}});ff(d);for(var e=
[],f=0,g=Object.keys(b),h=g.length;f<h;){var k=new z("delete","free",g[f],null);e.push(k);f++}f=0;for(g=d.length;f<g;)h=d[f],c.get(h.id).next!=h.next&&Ca(e,"free",h.id,{next:h.next}),f++;M(a,e,null)}function Ba(a,b){var c=0,c=a.storage.graph;if(b&&(c=c.getItem(b),Qc(a,c)))if("params"===c.role){x("delete parameters",[b]);var c=a.storage.graph.getNode(b),d=[];w(d,c.left);ca(d,b);M(a,d,null)}else if(c=c.type,"duration"===c)x("delete duration",[b]),c=a.storage.graph.getNode(b),d=[],w(d,c.right),ca(d,
b),M(a,d,null);else if("question"===c||"select"===c||"loopbegin"===c||"loopend"===c||"case"===c){x("complex delete",[b]);var d=a.storage.graph,c=[],e=0,f={nodes:{},edges:{},horHoles:{},verHoles:{},newEdges:{},stairs:{},mainDeletes:[b]},g=a.storage.graph,h=g.getNode(b),e=h.type;if("question"===e){var e=g.getNodeRight(h),k=g.getNode(e),l=v(k);L(g,h,f);f.edges[h.right]=!0;if("left-t"===l)L(g,k,f);else if("left-down"===l)f.nodes[e]=!0,f.edges[k.down]=!0,h=g.getNodeDown(k),Da(g,h,f,!0);else{if("left-up"!==
l)throw"Unexpected switch value: "+l;k=g.getNode(e);Sb(g,k,f)}}else if("select"===e)e=g.getNodeDown(h),e=g.getNode(e),k=g.getNodeDown(e),l=g.getNode(k),f.mainDeletes.push(k),L(g,h,f),L(g,e,f),L(g,l,f),pf(g,h.id,f);else if("case"===e)e=g.getNodeUp(h),k=g.getNode(e),g.getNodeDown(h),k.right?oc(g,k,f,"left","right",f.horHoles):(f.edges[k.left]=!0,f.nodes[e]=!0),f.edges[h.up]=!0,Da(g,h.id,f);else{if("loopbegin"===e)L(g,h,f),h=Drakon.findEndLoop(g,h);else{if("loopend"!==e)throw"Unexpected switch value: "+
e;L(g,h,f);h=Drakon.findBeginLoop(g,h)}h&&(e=g.getNode(h),f.mainDeletes.push(h),L(g,e,f))}qf(f,f.horHoles);qf(f,f.verHoles);H(d,a.render);for(var e=0,k=f.edges,l=Object.keys(k),u=l.length;e<u;)g=l[e],h=k[g],w(c,g),e++;g=0;h=Object.keys(f.nodes);for(e=h.length;g<e;)rf(d,c,h[g]),g++;for(var e=[],k=0,l=f.newEdges,u=Object.keys(l),m=u.length;k<m;){var p=l[u[k]];p.up in f.nodes||p.down in f.nodes||(g=t(a.storage),e.push(g),"up"===p.dir?(h=d.getNode(p.down),h=d.getEdge(h.up),Aa(c,g,p.up,p.down,h.role)):
(h=d.getNode(p.up),h=d.getEdge(h.right),G(c,g,p.up,p.down,h.role)));k++}d=null;1==e.length&&(d=e[0]);Rb(a,c,d)}else"branch"===c?(x("delete branch",[b]),l=a.storage.graph,u=Id(l,b),c=[],d=u.nodes,f=u.edges,m=l.getNode(u.top),e=l.getNodeLeftEx(m),k=l.getNode(u.bottom),u.isLastUp?h=g=null:(f[m.right]=!0,g=l.getNodeRightEx(m),u.isLast?h=null:(h=U(l,g.id),f[h.left]=!0)),f[m.left]=!0,u.exit?l=null:(l=l.getNodeLeftEx(k),f[k.left]=!0),Qb(c,d,f),g&&(E(a,c,e.id,g.id,null,null),h&&E(a,c,l.id,h.id,"sil_floor",
null)),M(a,c,null)):(x("delete one item",[b]),h=a.storage.graph,e=h.getItem(b),c=[],d=h.getNeighbourUp(b),f=h.getNeighbourDown(b),g=h.getEdge(e.down),w(c,e.up),w(c,e.down),rf(h,c,b),h=t(a.storage),Aa(c,h,d,f,g.role),Rb(a,c,h))}function ad(a,b,c,d){if(c.up&&c.down){var e=b.getEdge(c.up);b=b.getEdge(c.down);w(d,c.up);w(d,c.down);ca(d,c.id);a=t(a.storage);Aa(d,a,e.head,b.tail,b.role)}}function la(a,b,c,d){var e=null,f=a.storage.graph,g=b.getTail(c);w(d,c.id);if(g.left){c=b.getEdge(g.left);var h=b.getNode(c.head);
g.right?(w(d,g.left),f=f.getEdge(g.right),w(d,g.right),e=t(a.storage),G(d,e,c.head,f.tail,f.role),ca(d,g.id)):g.down||(w(d,g.left),ad(a,b,h,d),ca(d,g.id))}else if(g.right){f=b.getEdge(g.right);f=b.getNode(f.tail);c=v(f);w(d,g.right);if("left-up"===c){c=b.getNodeUp(f);var h=b.getNode(c),k=b.getNodeLeft(h),k=b.getNode(k);w(d,f.up);w(d,h.left);ca(d,f.id);ca(d,c);ad(a,b,k,d)}else ad(a,b,f,d);ca(d,g.id)}else Utils.throwError("Bad liana");return e}function hf(a){var b=m.storage.graph.getItem(a);(b=Pe(b))&&
Hb(b,a,null)}function Ob(a,b){var c=a.storage.graph,d=c.getEdge(b),e=c.getHead(d),c=c.getTail(d);if(c.right){x("delete middle path",[d.id]);var d=a.storage.graph,f=U(d,c.id),f=d.getNodeLeftEx(f),g=d.getNodeRightEx(c),h=U(d,g.id),k={},l={};k[e.id]=!0;k[f.id]=!0;k[g.id]=!0;k[h.id]=!0;d.enumerateManhattan(c.id,k,l);delete k[e.id];delete k[f.id];delete k[g.id];delete k[h.id];c=[];Qb(c,k,l);E(a,c,e.id,g.id,"parallel",null);E(a,c,f.id,h.id,null,null);M(a,c,null)}else{if(e.left)x("delete right path",[d.id]),
d=a.storage.graph,f=U(d,c.id),h=d.getNodeLeftEx(f),f={},g={},f[e.id]=!0,f[h.id]=!0,d.enumerateManhattan(c.id,f,g),delete f[e.id],delete f[h.id],e=[],Qb(e,f,g);else{x("delete last path",[d.id]);var d=a.storage.graph,f=U(d,c.id),f=d.getNodeLeftEx(f),g=d.getNodeUp(e),h=d.getNodeDown(e),k=d.getNodeUp(f),l=d.getNodeDown(f),u={},m={};u[e.id]=!0;u[f.id]=!0;d.enumerateManhattan(c.id,u,m);m[e.up]=!0;m[e.down]=!0;m[f.up]=!0;m[f.down]=!0;e=[];Qb(e,u,m);c=d.getEdge(f.down);h==f.id?C(a,e,g,l,c.role,null):(C(a,
e,g,h,"down",null),C(a,e,k,l,c.role,null))}M(a,e,null)}}function sf(a,b,c){he(a,b)?Sb(a,b,c):b.id in c.nodes&&(c.edges[b.right]=!0,b=a.getNodeRight(b),b=a.getNode(b),sf(a,b,c))}function v(a){if(a.up){if(a.left)return a.right?a.down?"cross":"up-t":a.down?"left-t":"left-up";if(a.right)return a.down?"right-t":"right-up";if(a.down)Utils.throwError("vertical");else return"lowest"}else if(a.left)if(a.right){if(a.down)return"t";Utils.throwError("horizontal")}else return a.down?"left-down":"rightmost";else{if(a.right)return a.down?
"right-down":"leftmost";if(a.down)return"highest";Utils.throwError("empty")}}function Tb(a){a.storage.selection=ua()}function tf(a,b,c){var d=0,e=0,f=0,e=a.getVertical(b.id),e=Utils.listToSet(e);for(c=a.getNode(c);;){if(c.id in e)for(f=0;;){c=a.getNodeUp(c);c=a.getNode(c);if(c.id==b.id)return!1;e=c.type;if("loopbegin"===e){if(0===f)return!0;f--}else"loopend"===e&&f++}d=c.type;if("loopend"===d){if(0===f)return!0;f--}else"loopbegin"===d&&f++;if(c.down)c=a.getNodeDown(c);else{if(!c.left||"left"!==a.getEdge(c.left).role)return!1;
c=a.getNodeLeft(c)}c=a.getNode(c)}}function pc(a,b,c){b=ie(a,b);b=uf(a,b,c);return tf(a,b,c)}function je(a,b,c){b=a.getNode(b);b=uf(a,b,c);return tf(a,b,c)}function sb(a){return"down"==a.role||"par-down"==a.role?!0:!1}function vf(a,b){var c=a.graph,d=a.free,e={};if("drakon"==m.storage.type)for(var f=0,g=c.nodes,h=Object.keys(g),k=h.length;f<k;){var l=h[f],l=g[l];if("branch"==l.type||"beginend"==l.type){var u=c,q=e;for(l.up&&(q[l.up]=!0);q[l.down]=!0,l=u.getNodeDownEx(l),l.down;);}f++}f=0;g=c.nodes;
h=Object.keys(g);for(k=h.length;f<k;)l=h[f],l=g[l],bd(b,l,e),f++;f=0;c=c.edges;g=Object.keys(c);for(h=g.length;f<h;)l=g[f],l=c[l],bd(b,l,e),f++;c=0;f=d.list;for(g=f.length;c<g;)l=f[c],l=d.set[l],bd(b,l,e),c++}function wf(a,b,c){var d=a.render,e=a.graph,f=e.getHead(b),e=e.getTail(b),g;c?(g=b.upperMark,c=3):(g=b.lowerMark,c=-3);g&&(a=xf(a,g),b.isVertical?(e=(e.y-f.y)/2,b=f.x+c,f=f.y+e,c=2,e-=5):(e=(e.x-f.x)/2,b=f.x+e,f=f.y+-c,c=e-5,e=2),d.createAction(b,f,c,e,a,null,"line_candies"))}function db(a,b){if(b.found){var c=
yf();a.createLine(b.min,b.edge,b.max-b.min,0,c,"guides")}}function zf(a){a=new qe(a);vf(m.storage,a)}function Jd(a,b){if(b.found){var c=yf();a.createLine(b.edge,b.min,0,b.max-b.min,c,"guides")}}function eb(a,b,c,d,e){var f=a.graph;for(b=new Utils.Box(b-Config.METRE,c+Config.METRE/2,b+Config.METRE,d);;){d=Af(f,b);if(!d)break;c=f.getItem(d);if(c.isLine){if(!c.isVertical&&"lstick"!=c.role){d=a;var g=b,h=e,k=d.graph;c=c.tail;for(var l=void 0;;){l=k.getNode(c);if(!l.right)break;c=k.getNodeRight(l)}d.moveRight(l.id,
g.left-l.box.right,h)}}else g=c.box,c="duration"==c.type?b.right-g.left:(b.left+b.right)/2>(g.left+g.right)/2?b.left-g.right:b.right-g.left,a.moveRight(d,c,e)}}function R(a,b,c,d,e){var f=a.graph,g;g=b.x;var h,k=[];h=b.id;for(var l="down";;){h=f.getNode(h);k.push(h);if(h.x<g&&h.y>c||"address"==h.type)break;if("down"===l)h.right?(h=f.getNodeRightEx(h),h.up?h=null:(h=h.id,l="right")):h.down?(h=f.getNodeDown(h),l="down"):h.left?(h=f.getNodeLeft(h),l="left"):h=null;else if("right"===l)h.right?(h=f.getNodeRight(h),
l="right"):h.down?(h=f.getNodeDown(h),l="down"):h=null;else if("left"===l)h.down?(h=f.getNodeDown(h),l="down"):h.left?(h=f.getNodeLeft(h),l="left"):h.up?(h=f.getNodeUp(h),l="up"):h=null;else{if("up"!==l)throw"Unexpected switch value: "+l;h.left?(h=f.getNodeLeft(h),l="left"):h.up?(h=f.getNodeUp(h),l="up"):h=null}if(!h)break}g=0==k.length?[b]:k;g=Q(f,b.id,g[g.length-1].id);g=Math.max(g.x,b.box.right+Config.METRE);g=Math.max(g,d);d=new Utils.Box(g-Config.METRE+1,b.y,g,c);g=0;f=f.nodes;k=Object.keys(f);
for(l=k.length;g<l;)h=f[k[g]],Utils.boxesIntersect(d,h.box)&&a.moveRight(h.id,d.right-h.box.left,e),g++;a.moveDown(b.id,c-b.y,e)}function fb(a,b,c){var d=m.storage.free,e=Ad(m);1==e.greens.length?(b=e.greens[0],d.get(b)?c(m,[b]):a(m,b),ub()):1<e.greens.length?(b(m),ub()):0!=e.frees.length&&(c(m,e.frees),ub())}function Bf(){if(!m.readonly&&m.dragOn){m.dragOn=!1;m.render.clearGuides();var a=[];if(wb){x("move items",[wb]);for(var b=m.canvas.graph,c=0,d=Object.keys(m.changedNodes),e=d.length;c<e;){var f=
d[c];if(!(f in b.nodes)){a=[];break}f=b.getNode(f);f=new z("update","nodes",f.id,{x:f.x,y:f.y});a.push(f);c++}}else{x("move free items",ra);for(var b=m.canvas.free,c=m.storage.free,d=0,e=ra,g=e.length;d<g;){var f=e[d],h=b.get(f),k=c.get(f);if(h.x!=k.x||h.y!=k.y)f=new z("update","free",f,{x:h.x,y:h.y}),a.push(f);d++}ra=[]}qb(m,a,null,!1,!1);a=fc(m);Cf(m,a)}}function Df(a,b){var c=a.getNode(b);return c.down?(c=a.getEdge(c.down),Df(a,c.tail)):c.left?!1:c.right?"right"===a.getEdge(c.right).role?!1:!0:
!1}function $a(a,b,c,d,e){m.dragOn=!1;Yc(a,b,d);Ef(a,c,e)}function ze(a,b){x("add line",[b]);var c=H(a.storage.graph,a.render),c=Ub(a,c,b);M(a,c,null)}function Ub(a,b,c){var d={},e={},f=b.graph,g=f.getEdge(c),h=f.getHead(g),f=f.getTail(g),k=f.x-h.box.right,g=4*Config.METRE;k<g&&(b.moveRight(f.id,g-k,d),k=g);k=h.box.right+Math.floor(k/Config.METRE/2)*Config.METRE;b.deletePhysicalItem(c);var l=t(a.storage),u=t(a.storage);b.insertPhysicalItem({id:l,x:k,y:h.y,type:"junction",isLine:!1});b.insertPhysicalEdge(u,
l,f.id,!1,null);b.rebuildCache();b.moveDown(f.id,g,d);delete d[l];I(b,d,e);b=Utils.objectValues(e);w(b,c);c=t(a.storage);d=t(a.storage);e=t(a.storage);l=t(a.storage);a=t(a.storage);g=h.y+g;N(b,l,k,h.y);N(b,a,k,g);vb(b,e,l,a);G(b,c,h.id,l,null);G(b,d,a,f.id,null);return b}function Ug(a,b,c,d){var e=a.graph.getNode(b),f=c-e.h,g=e.y-f;if(0<=f){var h=new Utils.Box(e.x-e.w,e.y,e.x+e.w,e.y),k={};a.pushObjects(h,{},-(2*f+e.h),"vertical",k);I(a,k,d)}a=cc(d,b);a.fields.h=c;a.fields.y=g}function Tg(a,b,c,d){var e=
a.graph.getNode(b),f=c-e.h,g=e.y+f;if(0<f){var e=new Utils.Box(e.x-e.w,e.y+e.h,e.x+e.w,e.y+e.h),h={};a.pushObjects(e,{},2*f,"vertical",h);I(a,h,d)}a=cc(d,b);a.fields.h=c;a.fields.y=g}function qa(a,b,c,d){var e=a.graph,f=e.getEdge(b);b=e.getHead(f);e=e.getTail(f);b=e.box.top-b.box.bottom;c=2*(Config.METRE+c);b<c&&a.moveDown(e.id,c-b,d)}function rh(a,b){return b.up?a.getNodeUp(b):null}function cd(a,b){var c=a.getNode(b),c=a.getNodeDownEx(c),d=a.getNodeLeftEx(c);return"question"==d.type?c.id:d.left?
null:d.id}function sh(a,b){return b.down?a.getNodeDown(b):null}function Id(a,b){var c={},d={},e=a.getNode(b),f=a.getNodeUpEx(e);a.getNodeLeftEx(f);e=U(a,e.id);c[f.id]=!0;var g,h,k,l,u;f.right?(g=a.getNodeRightEx(f),u=U(a,g.id),g="end"==u.type,k=!1,g?h=Ra(a,e.id):(c[u.id]=!0,h=a.getNodeLeftEx(u)),l=a.getNodeLeftEx(e),c[l.id]=!0):(u=null,g=!0,(k="end"==e.type)?(h=Ra(a,e.id),l=null):(h=Ra(a,e.id),l=a.getNodeLeftEx(e),c[l.id]=!0));a.enumerateManhattan(b,c,d);l&&(delete c[l.id],delete d[e.left]);u&&(delete c[u.id],
delete d[u.left]);return{nodes:c,edges:d,top:f.id,bottom:e.id,rBottom:h.id,isLast:g,exit:k,isLastUp:!f.right}}function Ff(a,b,c){b=new Qg(b,b.id,c);for(var d=0,e=a.storage.graph.items,f=Object.keys(e),g=f.length;d<g;){c=f[d];var h=e[c];b.check(c,h);d++}d=0;a=a.storage.free.set;e=Object.keys(a);for(f=e.length;d<f;)c=e[d],h=a[c],b.check(c,h),d++;return b.found}function Gf(a,b,c){for(var d=[],e=0;!(0>e);){if(b.up)b=a.getEdge(b.up),sb(b)&&b.upperMark===c&&0===e&&d.push(b.id),b=a.getNode(b.head);else{if(!cb(a,
b))break;b=Hf(a,b.id)}"loopbegin"===b.type?e--:"loopend"===b.type&&e++}return d}function dd(a){var b=Number.MAX_VALUE,c=-Number.MAX_VALUE,d=Number.MAX_VALUE,e=-Number.MAX_VALUE,e=If(a,b,d,c,e);a=Config.METRE;b=Ea(e.left,0);c=Ea(e.right,300);d=Ea(e.top,0);e=Ea(e.bottom,300);return new Utils.Box(b-a,d-a,c+a,e+a)}function If(a,b,c,d,e){var f=0;a=a.nodes;for(var g=Object.keys(a),h=g.length;f<h;){var k=a[g[f]].box;b=Math.min(b,k.left);c=Math.min(c,k.top);d=Math.max(d,k.right);e=Math.max(e,k.bottom);f++}return new Utils.Box(b,
c,d,e)}function Jf(a,b){var c=Kf(a,b);if(c)return new ya(c,Const.DRN_SOCKET,null);for(c=m.grips.length-1;;){if(!(0<=c)){a:for(var c=a,d=b,e=m.storage.free,f=void 0,f=e.list.length-1;;){if(!(0<=f)){c=null;break a}var g=e.list[f],h;var k=e.set[g];h=c;var l=d,u=ea.getItemCallback(k.type);u.hit?h=u.hit(k,h,l):(k=Utils.boxFromPoint(k.x,k.y,k.w,k.h),h=Utils.hitBox(k,h,l));if(h){c=g;break a}f--}return c?mf(m,c,a,b):(c=m.canvas.pgraph.findPhysicalItem(a,b))?mf(m,c,a,b):null}d=m.grips[c];if(Utils.hitBox(d.touchBox,
a,b))return new ya(d.id,d.type,Utils.copyObject(d.dims));c--}}function Lf(a){for(var b=0,c=a.length;;){if(!(b<c)){Utils.throwError("down edge not found");break}var d=a[b];if("insert"==d.type&&"edges"==d.table&&sb(d.fields))return d.id;b++}}function Mf(a,b){Kd=!0;var c=fc(a);if(!b||b in c){for(var d=[],e=0,c=Object.keys(c),f=c.length;e<f;){var g=c[e];D(a.storage,g).free&&d.push(g);e++}return d}Kd=!1;return[b]}function Q(a,b,c){var d=new Utils.Point(-1E6,-1E6),e=a.getNode(b),f=e.x;Vb(e,d);b==c?Vb(e,
d):e.right?Ld(f,a,e,c,d):e.down?Wb(f,a,e,c,d):Xb(f,a,e,c,d);d.y+=Config.METRE;d.x+=Config.METRE;return d}function Ma(a,b,c){b=ie(a,b);var d=a.getNodeDown(b);return d==c?new Utils.Point(b.box.right,b.box.bottom):Q(a,d,c)}function th(a,b){return b.left?a.getNodeLeft(b):null}function uf(a,b,c){var d=1E8,e=null;uh(a,b,c,function(a){a.x<d&&(d=a.x,e=a)});return e}function vh(a,b){for(var c=[],d=b;;){var e=a.getNodeUpEx(d);c.push(d);c.push(e);if(!d.right)break;d=a.getNodeRightEx(d)}return c}function Dd(a,
b,c){var d=[],e=0;a=a.nodes;for(var f=Object.keys(a),g=f.length;e<g;){var h=a[f[e]];h[b]===c&&d.push(h);e++}return d}function Pe(a){var b=m.storage.graph,c=null;a.isLine||"junction"==a.type||(a.up?(c=b.getNodeUpEx(a),"junction"==c.type?(a=v(c),"left-down"===a?(b=b.getNodeLeftEx(c),c="up-t"==v(b)?"mdh02":"mdh03"):"right-down"===a?(b=b.getNodeRightEx(c),c="up-t"==v(b)?"mdh04":"mdh05"):c="mdh06"):c="mdh01"):a.left&&(a=Md(b,a.id),a.up&&(a.down?c="mdv03":(c=b.getNodeUpEx(a),c="link"==b.getEdge(c.right).role?
"mdv01":"header"==b.getNodeRightEx(c).role?"mdv01":"mdv02"))));return c}function ic(a,b){for(var c=0,d=a.nodes,e=Object.keys(d),f=e.length;;){if(!(c<f))return null;var g=d[e[c]];if(g.role===b)return g;c++}}function ie(a,b){var c=a.getNode(b),c=a.getNodeUp(c);return Nf(a,c)}function Nf(a,b){for(var c=b;;){c=a.getNode(c);if(cb(a,c))break;c=a.getNodeUp(c)}c=a.getNodeLeft(c);a:for(;;){c=a.getNode(c);if(c.down)break a;if(!c.left){c=a.getNodeUp(c);c=Nf(a,c);break a}c=a.getNodeLeft(c)}return c}function wh(a,
b){return b.right?a.getNodeRight(b):null}function Kf(a,b){for(var c=0,d=m.canvas.sockets,e=Object.keys(d),f=e.length;;){if(!(c<f))return null;var g=e[c];if(Utils.hitBox(d[g].box,a,b))return g;c++}}function xh(a,b){var c=v(b);if("up-t"===c){var c=a.getNodeUp(b),d=a.getNode(c);return"address"==d.type?c:null}if("right-t"===c){c=a.getNodeRight(b);d=a.getNode(c);if("junction"==d.type){if("left-up"==v(d))return c;c=a.getEdge(b.right);return"arrow"==c.role?cd(a,c.tail):null}return null}if("left-t"===c)return c=
a.getNodeLeft(b),d=a.getNode(c),"junction"==d.type&&"right-up"==v(d)?c:null;if("left-down"===c){var e=a.getEdge(b.left);return"arrow"==e.role?cd(a,b.id):null}if("left-up"===c){if(ge(a,b))return b.id;e=a.getEdge(b.left);if(e.role){if("sil_floor"==e.role)return a.getNodeUp(b);c=a.getNodeUp(b);d=a.getNode(c);if("arrow"==a.getEdge(d.left).role)return d=a.getNode(e.head),d.left?null:d.id}}return null}function Of(a){for(var b=null,c=1E9,d=0,e=a.storage.graph.items,f=Object.keys(e),g=f.length;d<g;){var h=
f[d],k=e[h];k.y<c&&(b=h,c=k.y);d++}d=0;a=a.storage.free.set;e=Object.keys(a);for(f=e.length;d<f;)h=e[d],k=a[h],k.y<c&&(b=h,c=k.y),d++;return b}function yh(a,b){var c;c=a.getItem(b);if(tb(a,b))return b;if(c.isLine){if(c.isVertical){var d=a.getHead(c),e=a.getTail(c);"junction"==d.type&&"junction"==e.type?(c=v(d),e=v(e),c="left-down"==c&&"left-up"==e?"arrow"==a.getEdge(d.left).role?cd(a,d.id):null:null):c="address"==d.type?d.id:"address"==e.type?e.id:null}else{var f=0,d=a.getHead(c),e=a.getTail(c);if("junction"==
e.type){var g=v(e),f=d.type;"junction"===f?(f=v(d),c="left-up"!=g||"right-t"!=f&&"up-t"!=f?"left-t"==g&&"right-up"==f||"left-up"==g&&"right-up"==f?d.id:"right-t"==f&&"left-down"==g&&"arrow"==c.role?cd(a,e.id):null:e.id):c="question"===f?"left-up"===g?e.id:"left-t"===g?c.id:null:null}else c=null}return c&&tb(a,c)?c:null}return"junction"==c.type?(c=xh(a,c))&&tb(a,c)?c:null:null}function Pf(a,b){var c=Jf(a,b);return c&&c.type!=Const.DRN_SOCKET?c:null}function t(a){var b=a.nextId;a.nextId++;return String(b)}
function D(a,b){var c=a.free.get(b);c||(c=a.graph.getItem(b));return c}function qc(a,b){return ea.getItemCallback(a.type).makeBox(a,a.x,a.y,b)}function de(a,b){var c;c=b.isLine?a.getHead(b):b;return c.down?(c=a.getNodeDown(c),c=a.getNode(c),"case"==c.type||"branch"==c.type?c:null):null}function Z(a){return T()==a?(a=P.getClipboard)?a():null:null}function T(){var a=P.getClipboardType;return a?a():null}function S(a){return a.content||new Utils.Content("","")}function Za(a){var b=null,c=P.getDefault;
c&&(b=c(a));return b}function Qf(a){a=a.storage;var b=a.free,c=a.graph.edges,c={name:a.name,type:a.type,nodes:mc(a.graph.nodes),edges:mc(c)};c.background=a.background;c.diaLine=a.diaLine;c.diaLineThickness=a.diaLineThickness;c.font=a.font;c.version=a.version;0!=b.list.length&&(c.free=mc(b.set));b=Utils.sanitizeDiagram(c);gb(a,"background",b);gb(a,"diaLine",b);gb(a,"diaLineThickness",b);gb(a,"font",b);return b}function Sa(){return Nd.end?Nd.end:n("DIA_END")}function yf(){return{lineThickness:1,lineColor:"#800000"}}
function zh(){if("drakon"==m.storage.type)return{left:Ah,up:Bh,right:Ch,down:Dh};var a=function(a,c){return c};return{left:a,up:a,right:a,down:a}}function lc(a){var b=0,c=0;a=a.nodes;for(var d=Object.keys(a),e=d.length;c<e;)"junction"!=a[d[c]].type&&b++,c++;return b}function ee(a,b){var c=0,d=a.storage.graph,e=c=null,f=[];if(b.isLine)if(c=b.role,"bridge"===c){var e=d.getNode(b.tail),g=Rf(d,e),g=d.getNodeDownEx(g);f.push({text:"MES_ADD_ITEM",itemId:g.id,action:"mih06"})}else"arm"===c&&(c=d.getNode(b.tail),
g=Ra(d,c.id),f.push({text:"MES_ADD_ITEM",itemId:g.id,action:"miv03"}));else"junction"==b.type?(e=v(b),c=Mind.getHorParent(d,b.id),"right-down"===e?"bridge"==d.getEdge(b.right).role&&f.push({text:"MES_ADD_ITEM",itemId:c.id,action:"mih05"}):"left-down"===e?(e=d.getEdge(b.left),"bridge"==e.role&&f.push({text:"MES_ADD_ITEM",itemId:c.id,action:"mih03"})):"up-t"===e?(e=d.getEdge(b.left),"bridge"==e.role&&(c=d.getNode(e.head),d=d.getNodeDownEx(c),f.push({text:"MES_ADD_ITEM",itemId:d.id,action:"mih06"}))):
"right-up"===e&&"arm"==d.getEdge(b.up).role&&(g=Ra(d,b.id),f.push({text:"MES_ADD_ITEM",itemId:g.id,action:"miv02"}))):(b.up&&(e=d.getNodeUpEx(b),"junction"==e.type?(c=Mind.getHorParent(d,e.id),e.left?(g=Rf(d,e),g=d.getNodeDownEx(g),e.right?(f.push({text:"MES_ADD_LEFT_ITEM",itemId:g.id,action:"mih06"}),f.push({text:"MES_ADD_RIGHT_ITEM",itemId:b.id,action:"mih06"})):(f.push({text:"MES_ADD_LEFT_ITEM",itemId:g.id,action:"mih06"}),f.push({text:"MES_ADD_RIGHT_ITEM",itemId:c.id,action:"mih03"}))):(f.push({text:"MES_ADD_LEFT_ITEM",
itemId:c.id,action:"mih05"}),f.push({text:"MES_ADD_RIGHT_ITEM",itemId:b.id,action:"mih06"}))):(f.push({text:"MES_ADD_LEFT_ITEM",itemId:e.id,action:"mih04"}),f.push({text:"MES_ADD_RIGHT_ITEM",itemId:e.id,action:"mih02"}))),b.left&&(c=Md(d,b.id),c.up&&f.push({text:"MES_ADD_ITEM_ABOVE",itemId:b.id,action:"miv03"}),c.down?(c=d.getNodeDownEx(c),g=Ra(d,c.id),f.push({text:"MES_ADD_ITEM_BELOW",itemId:g.id,action:"miv03"})):f.push({text:"MES_ADD_ITEM_BELOW",itemId:b.id,action:"miv02"})),b.down||(!b.up&&"header"!=
b.role||b.left||f.push({text:"MES_ADD_CHILD",itemId:b.id,action:"mih01"}),d=b.left?"link"==d.getEdge(b.left).role||"header"==b.role?!0:!1:!1,d||("header"==b.role?f.push({text:"MES_ADD_VER_CHILD",itemId:b.id,action:"miv04"}):f.push({text:"MES_ADD_VER_CHILD",itemId:b.id,action:"miv01"}))));d={MES_ADD_LEFT_ITEM:"mind-left.png",MES_ADD_RIGHT_ITEM:"mind-right.png",MES_ADD_ITEM_ABOVE:"mind-up.png",MES_ADD_ITEM_BELOW:"mind-down.png",MES_ADD_VER_CHILD:"mind-ver2.png",MES_ADD_CHILD:"mind-hor.png",MES_PASTE_LEFT_ITEM:"mind-left.png",
MES_PASTE_RIGHT_ITEM:"mind-right.png",MES_PASTE_ITEM_ABOVE:"mind-up.png",MES_PASTE_ITEM_BELOW:"mind-down.png",MES_PASTE_VER_CHILD:"mind-ver2.png",MES_PASTE_CHILD:"mind-hor.png"};c=0;for(e=f.length;c<e;)g=f[c],g.text in d&&(g.image=d[g.text]),c++;d=0;for(c=f.length;d<c;)e=f[d],e.type=Mind.getDefaultIconType(e.action),d++;return f}function cc(a,b){if(b in a)return a[b];var c=new z("update","nodes",b,{});return a[b]=c}function Ea(a,b){return a===Number.MAX_VALUE?b:a===-Number.MAX_VALUE?b:a}function Wc(a,
b){for(var c=a.getNode(b),d=a.getNodeDown(c),c=[];;){d=a.getNode(d);c.push(d);if(!d.right)break;d=a.getNodeRight(d)}return c}function fc(a){var b={};if(a=a.storage.selection)b=a.ids;return b}function rc(){var a=fc(m);return Object.keys(a)}function Yb(a,b){for(var c=0,d=a.getVertical(b),e=d.length;;){if(!(c<e))return Config.DEF_ICON_WIDTH;var f=a.getItem(d[c]);if(Drakon.isWideIcon(f))return f.w;c++}}function Sf(a,b){return Mind.mustFitSiblings(b)?m.storage.graph.getNode(a).w:Config.DEF_ICON_WIDTH}
function xf(a,b){var c,d=a.zoneColors;if(b in d)c=d[b];else{c=Math.floor(205*Math.random())+51;var e=Math.floor(205*Math.random())+51,f=Math.floor(205*Math.random())+51;c="rgb("+c+", "+e+", "+f+")";d[b]=c}return c}function Od(a,b){var c=a[b];delete a[b];var d,e;d=c.up in a?Od(a,c.up).up:c.up;e=c.down in a?Od(a,c.down).down:c.down;return{up:d,down:e,dir:c.dir}}function qf(a,b){for(var c={},d=0,e=Object.keys(b),f=e.length;d<f;){var g=e[d];if(g in b){var h=Od(b,g);c[g]=h}d++}d=0;e=Object.keys(c);for(f=
e.length;d<f;)g=e[d],a.newEdges[g]=c[g],d++}function U(a,b){for(var c=a.getNode(b);c.down;)b=a.getNodeDown(c),c=a.getNode(b);return c}function Md(a,b){for(var c=a.getNode(b);c.left;)b=a.getNodeLeft(c),c=a.getNode(b);return c}function Ra(a,b){for(var c=a.getNode(b);c.right;)b=a.getNodeRight(c),c=a.getNode(b);return c}function fe(a,b){for(var c=a.getNode(b);c.up;)b=a.getNodeUp(c),c=a.getNode(b);return c}function Dh(a,b){var c=a.graph;if(b){for(var d=new Utils.Set,e=0,f=b.list,g=f.length;e<g;){var h=
f[e];d.add(h);h=c.getItem(h);if(Tf(h)&&(h=c.getNodeUpEx(h),d.add(h.id),h.right)){var k=c.getNodeRightEx(h);d.add(h.right);d.add(k.id)}e++}return d}return null}function Ah(a,b){if(b){var c=new Utils.Set;Uf(a,b.list,c);return c}return null}function Uf(a,b,c){for(var d=a.graph,e=0,f=b.length;e<f;){var g=b[e];c.add(g);var h=d.getItem(g);if(!h.isLine&&h.right&&h.down&&!h.left&&(h.up||"beginend"==h.type)){for(var g=d,k=h,h=[];k.right;)k=g.getNodeRightEx(k),h.push(k.id);g=0;for(k=h.length;g<k;){var l=h[g];
l in c.map||(l=a.getTeam(l,"horizontal"),Uf(a,l.list,c));g++}}e++}}function Ch(a,b){var c=a.graph;if(b){for(var d=new Utils.Set,e=0,f=b.list,g=f.length;e<g;){var h=f[e];d.add(h);h=c.getItem(h);if(Tf(h)){var h=c.getNodeLeftEx(h),k=c.getNodeDownEx(h);d.add(h.id);d.add(k.id);d.add(h.down)}e++}return d}return null}function Bh(a,b){return b}function oh(a,b){var c=a.getTail(b);if("junction"===c.type){var d=v(c);return"right-t"===d?!0:"left-t"===d?(c=a.getEdge(c.left),"junction"===a.getHead(c).type?!0:!1):
!1}return!0}function cb(a,b){return b.left&&!Drakon.getDuration(a,b)?!0:!1}function Tc(a){var b=0,b=a.type;return"shelf"===b||"input"===b||"output"===b||"process"===b?!0:!1}function nf(a,b,c){a=Utils.boxFromPoint(a.x,a.y,a.w-2*Config.ICON_PADDING,a.h-Config.ICON_PADDING);return Utils.hitBox(a,b,c)}function Af(a,b){for(var c=0,d=a.items,e=Object.keys(d),f=e.length;;){if(!(c<f))return null;var g=d[e[c]];if(Utils.boxesIntersect(b,g.box))return g.id;c++}}function F(){return m.readonly||m.dragOn?!0:!1}
function V(a,b,c){kc(a,2)&&(b=Vf(a,b,c,""))&&(Fa(a,b),a.redraw())}function Pd(a,b,c,d){x("insert branch",[b,Utils.copyObject(c)]);var e=H(a.storage.graph,a.render),f=e.graph,g=a.storage.graph,h={},k={},l=f.getNode(b),l=f.getNodeUpEx(l),u,m,p;if(l.right){var r=f.getNodeRightEx(l),y=f.getNodeDownEx(r),n=U(f,y.id);g.getNode(n.id);p=S(g.getNode(y.id));u=!1;if("end"==n.type){m=!0;var A=U(f,b),g=Ra(f,A.id)}else m=!1,g=f.getNodeLeftEx(n)}else p=Utils.copyObject(c),m=u=!0,A=U(f,b),g=Ra(f,A.id);p=J(p.txt);
var v=Y(1,W,"end",J(Sa())),K=Y(1,a.render,"branch",c),D=Y(1,a.render,"address",p),G=K.w,da=f.getNodeUpEx(g),A=Q(f,b,da.id),z=g.box.top-Config.METRE;z<A.y&&(A=g.y+(A.y-z),R(e,g,A,da.box.right+Config.METRE,h));A=Q(f,b,da.id);b=Math.max(A.x,da.box.right+Config.METRE);if(!u){da=y.box.left;for(A=y;A.down;)A=f.getNodeDownEx(A),"junction"!=A.type&&(da=Math.min(da,A.box.left),A.left&&(z=f.getNodeLeftEx(A),da=Math.min(da,z.box.left)));f=da-Config.METRE-2*G;b>f&&e.moveRight(y.id,b-f,h)}y=l.y+Config.METRE+K.h;
f=g.y-Config.METRE-D.h;b+=G;var da=t(a.storage),A=t(a.storage),z=t(a.storage),F=t(a.storage);I(e,h,k);e=Utils.objectValues(k);u||w(e,l.right);m||w(e,g.right);N(e,A,b,l.y);ga(W,e,da,"branch",b,y,G,K.h,c);C(a,e,A,da,null);E(a,e,l.id,A,null);d?(ga(W,e,F,"end",b,y+2*K.h+v.h,v.w,v.h,J(Sa())),C(a,e,da,F,"down")):(ga(W,e,F,"address",b,f,G,D.h,p),N(e,z,b,g.y),C(a,e,da,F,"down"),C(a,e,F,z,null),E(a,e,g.id,z,"sil_floor"),u||E(a,e,A,r.id,null),m||E(a,e,z,n.id,"sil_floor"));M(a,e,da);return da}function bd(a,
b,c){var d=a.render,e=a.graph,f=a.free;b=La(b);"vertical"==b.type&&b.id in c&&(b.isSkewer=!0);b.free?f.add(b.id,b):(e.addItem(b),a.pgraph.insertPhysicalItem(b));ea.renderItem(e,d,b,{})}function Wf(a,b){var c=a.render,d,e=a.graph;d=b.id;var f=b.type,g=b.action,h,k=e.getItem(d);if(k.isLine)if(h=e.getHead(k),e=e.getTail(k),k.isVertical)k=h.y+h.h,e=e.y-e.h,h=h.x,e=Math.floor((k+e)/2);else{var k=h.x+h.w,l=e.x-e.w,e=h.y;h=Math.floor((k+l)/2)}else g.action?(h=k.x+g.dx,e=k.y+g.dy):(h=k.x,e=k.y);h=new Utils.Point(h,
e);d=new Sg(d,h,f,g);d.prim=c.addSocket(d.center.x,d.center.y);d.name=b.name;a.sockets[d.prim]=d}function Xf(a,b,c){x("insert case",[b,Utils.copyObject(c)]);var d=t(a.storage),e=H(a.storage.graph,a.render),f=e.graph,g={},h={},k=Y(d,a.render,"case",c),l=f.getNode(b);b=f.getNodeUp(l);c=f.getNode(b);var u=c.y+2*(k.h+Config.METRE),m=l.box.right+k.w+Config.METRE,p=m-l.x+k.w,r=f.getNodeDown(l),u=Math.max(u,l.y+l.h+Config.METRE),y,n;c.right?(y=new Utils.Box(l.x,l.box.top,l.x,u),n=f.getNodeRight(c)):(y=new Utils.Box(l.x,
c.y,l.x,u),n=null);var A=c.y+Config.METRE+k.h;qa(e,l.down,Config.METRE+k.h,g);e.pushObjects(y,{},p,"horizontal",g);I(e,g,h);e=Utils.objectValues(h);w(e,l.down);c.right&&w(e,c.right);k.x=m;k.y=A;Ya(e,d,k);f=fa(a,f,l.id,r,u,e);g=t(a.storage);h=t(a.storage);N(e,g,m,u,null);N(e,h,m,c.y,c.group);C(a,e,d,g,"down",null);E(a,e,f,g,"left",null);E(a,e,b,h,null,null);C(a,e,h,d,null,null);c.right&&E(a,e,h,n,null,null);M(a,e,d);return d}function Yf(a,b,c){x("insert duration",[b,Utils.copyObject(c)]);var d=a.storage.graph,
e=a.render,f=H(d,e);c=Y(1,e,"duration",c);var d=d.getNode(b),g=d.w+c.w+Config.METRE,e=d.x-g,h={},k={},l=new Utils.Box(d.x,d.y,d.x,d.y);f.pushObjects(l,{},-g-c.w,"horizontal",k);g=new Utils.Box(e-c.w,d.y,e+c.w,d.y);f.pushObjects(g,{},c.h,"vertical",k);f.pushObjects(g,{},-c.h,"vertical",k);I(f,k,h);f=Utils.objectValues(h);h=t(a.storage);c.x=e;c.y=d.y;Ya(f,h,c);E(a,f,h,b,"lstick",null);M(a,f,h);return h}function Vf(a,b,c,d){d=J(d);if("question"===c)return Zf(a,b,d);if("select"===c){c=J("Case 1");var e=
J("Case 2"),f=J("Case 3");d=Ge(a.render,d,[c,e,f]);return Ga(a,b,d,"insert 'select'")}if("case"===c)return Xf(a,b,d);if("branch"===c)return Pd(a,b,d,!1);if("end_branch"===c)return Pd(a,b,d,!0);if("foreach"===c)return d=Ee(a.render,d,J("")),Ga(a,b,d,"insert 'for each'");if("params"===c){x("insert parameters",[]);var f=a.storage.graph,g=a.render;d={};c={};var e=H(f,g),h={type:"action",content:null,isLine:!1,x:0,y:0,w:Config.DEF_ICON_WIDTH_S},k=ea.getItemCallback("action");b=Drakon.fitItem(h,g);xb(h,
b);k.makeBox(h,0,0,g);g=ic(f,"header");f=e.graph.getNode(g.id);h={};h[f.id]=!0;g=b.w+2*Config.METRE+g.w;e.pushObjects(f.box,h,g,"horizontal",d);I(e,d,c);d=Utils.objectValues(c);c=t(a.storage);d.push(new z("insert","nodes",c,{type:"action",x:f.x+g,y:f.y,w:b.w,h:b.h,content:null,role:"params"}));E(a,d,f.id,c,null,null);M(a,d,c);return c}return"duration"===c?Yf(a,b,d):"parallel"===c?(d=5,f=5*Config.METRE,g=10*Config.METRE,c=za(1,0,0),e=za(2,f,0),f=za(3,f,g),g=za(4,0,g),h=new Utils.Manhattan,h.addItem(c),
h.addItem(e),h.addItem(f),h.addItem(g),h.addItem(ma(d++,!1,c.id,e.id,"parallel")),h.addItem(ma(d++,!0,e.id,f.id,"par-down")),h.addItem(ma(d++,!1,g.id,f.id,null)),h.addItem(ma(d++,!0,c.id,g.id,"par-down")),Ga(a,b,{graph:h,first:c.id,last:g.id},"insert 'parallel'"),null):"path"===c?$f(a,b):ag(a,b,c,d)}function fa(a,b,c,d,e,f){var g=b.getNode(c).x,h=t(a.storage),k=t(a.storage);a=t(a.storage);N(f,a,g,e);vb(f,h,c,a);d&&(c="down",e=b.getNode(d),e.up&&(c=b.getEdge(e.up).role),Aa(f,k,a,d,c));return a}function $f(a,
b){kc(a,5)&&(a.storage.graph.getItem(b).isLine?Gd(a,b):Ne(a,b));return null}function Gd(a,b){x("add inside path",[b]);var c=H(a.storage.graph,a.render),d={},e={},f=c.graph,g=f.getEdge(b),h=f.getNode(g.head),g=f.getNode(g.tail),k=U(f,g.id),l=k.y;g.x-h.x<3*Config.METRE&&c.moveRight(g.id,4*Config.METRE,d);var m=g.x-Config.METRE;eb(c,m,g.y,l,d);I(c,d,e);c=Utils.objectValues(e);f=f.getNodeLeft(k);w(c,b);w(c,k.left);d=t(a.storage);e=t(a.storage);N(c,d,m,g.y);N(c,e,m,k.y);E(a,c,h.id,d,"parallel",null);E(a,
c,d,g.id,"parallel",null);E(a,c,f,e,null,null);E(a,c,e,k.id,null,null);C(a,c,d,e,"par-down",null);M(a,c,null)}function Ne(a,b){x("add outside path",[b]);var c=H(a.storage.graph,a.render),d={},e={},f=c.graph,g=f.getNode(b),h=U(f,b),k=Q(f,g.id,h.id),f=k.x;$e(c,g.x,f,g.y,k,h,d);k.y>h.y&&c.moveDown(h.id,k.y-h.y,d);I(c,d,e);c=Utils.objectValues(e);d=t(a.storage);e=t(a.storage);N(c,d,f,g.y);N(c,e,f,h.y);C(a,c,d,e,"par-down",null);E(a,c,g.id,d,"parallel",null);E(a,c,h.id,e,null,null);M(a,c,null)}function Zf(a,
b,c){c=Fe(a.render,c,1);return Ga(a,b,c,"insert 'question'")}function ag(a,b,c,d){c=He(a.render,c,d);return Ga(a,b,c,"insert item")}function Ga(a,b,c,d){var e=a.storage.graph.getEdge(b),f=pa(a),g=pa(a);g.selection=ua();var h=[];e.isVertical||(h=H(a.storage.graph,a.render),h=Ub(a,h,b),x(d+"-expand-bolt",[b]),b=Lf(h),h=hb(a,h,g,!1));x(d,[b]);var e=a.storage.graph,k=a.render,l=H(c.graph,k);c.pgraph=l;var m=Yb(e,b);d={};Drakon.setSkewerWidth(k,l,c.first,m,d);for(var l=c.graph,m=0,q=Object.keys(d),p=q.length;m<
p;){var r=q[m],y=d[r];if("update"==y.type&&"nodes"==y.table)for(var r=l.getNode(r),n=0,y=y.fields,A=Object.keys(y),v=A.length;n<v;){var K=A[n];r[K]=y[K];n++}m++}d=H(c.graph,k);l=dd(d.graph);l.left+=Config.METRE;l.top+=Config.METRE;l.right-=Config.METRE;l.bottom-=Config.METRE;d=e.getEdge(b);m={};e=H(e,k);q=d.tail;p=a.render;r=a.storage.graph;k=r.getNode(d.head);r=r.getNode(q);n=qc(k,p);y=qc(r,p);p=new Utils.Point(k.x,n.bottom+Config.METRE-l.top);y=n.bottom+2*Config.METRE+(l.bottom-l.top)+(r.y-y.top);
n={};y>r.y&&e.moveDown(q,y-r.y,n);q={};r=new Utils.Box(l.left+p.x,l.top+p.y,k.x,l.bottom+p.y);e.pushObjects(r,q,l.right,"horizontal",n);k=new Utils.Box(k.x,l.top+p.y,l.right+p.x,l.bottom+p.y);e.pushObjects(k,q,l.left,"horizontal",n);I(e,n,m);k=Utils.objectValues(m);w(k,b);l=c.graph.getNode(c.first);e=e.graph.getNode(d.head);b=e.x;e=e.box.bottom+Config.METRE-l.y;l=c.graph;m=l.getNode(c.first);Zc(l,b,e+m.h);e={};Zd(a,c,k,e);b=e[c.first];c=e[c.last];e=t(a.storage);l=t(a.storage);vb(k,e,d.head,b);Aa(k,
l,c,d.tail,d.role);c=hb(a,k,g,!0);h=h.concat(c);h=Vc(h);Ib(a.undo,f,h,g);return b}function he(a,b){return"left-up"===v(b)?a.getEdge(b.up).role?!1:"sil_floor"===a.getEdge(b.left).role?!1:!0:!1}function Ye(a,b){if(b.isLine&&!b.isVertical&&"left"==b.role){var c=a.getTail(b),d=a.getHead(b),c=v(c);return"up-t"==v(d)&&"up-t"==c?!0:!1}return!1}function Ze(a,b){if(b.isLine&&!b.isVertical){var c=a.getTail(b),d=a.getHead(b),c=v(c);if("right-t"==v(d)&&"up-t"==c)return c=a.getNodeDownEx(d),"junction"==c.type?
"left-up"==v(c)?"par-down"==a.getEdge(d.up).role?!1:!0:!1:!1}return!1}function Nb(a,b){var c=a.getHead(b),d=a.getTail(b);return sb(b)&&"junction"===c.type?"left-down"===v(c)&&"junction"===d.type?"right-up"===v(d)?!0:!1:!1:!1}function Tf(a){return"junction"==a.type&&a.left&&a.up&&a.down&&a.right?!0:!1}function Se(a){a=v(a);return"left-t"===a||"left-up"===a?!0:!1}function $c(a){return"junction"==a.type?"left-down"==v(a)?!0:!1:!1}function We(a,b){var c;c=a.getHead(b);c.up?(c=a.getEdge(c.up),c=We(a,c)):
c="beginend"===c.type?!0:!1;return c}function ch(a,b){var c=a.getNodeUp(b);return a.getNode(c).right?!1:!0}function ia(){return m.storage?"mind"==m.storage.type:!1}function ke(a,b){var c,d;c=a.getHead(b);var e=a.getTail(b);d=e.y-c.y-c.h-e.h;return"junction"===c.type?(c=v(c),"left-down"!==c||d>Config.METRE?!1:!0):"junction"===e.type?(c=v(e),"left-up"!==c||d>Config.METRE?!1:!0):!1}function le(a,b){if("junction"==b.type&&"left-up"==v(b)){var c=a.getNodeUpEx(b);return b.y-(c.y+c.h)<2*Config.METRE?!0:
!1}return!1}function gh(a,b){var c=a.getHead(b),d=a.getTail(b);return b.role||b.isVertical||"question"!==c.type||"junction"!==d.type?!1:"left-down"===v(d)?!1:!0}function Xe(a,b){return b.isLine&&Utils.canInsertInHorizontal(a,b)?a.getTail(b).down?!0:!1:!1}function re(a){var b=0;a=a.nodes;for(var c=Object.keys(a),d=c.length;;){if(!(b<d))return!1;if("branch"===a[c[b]].type)return!0;b++}}function bg(a,b){var c=fe(a,b),c=a.getNodeDown(c);return"case"===a.getNode(c).type?!0:!1}function Oc(a){return"junction"==
a.type&&a.up&&a.left&&a.right&&!a.down?!0:!1}function Me(a,b){return"junction"==b.type&&b.left&&!b.right?"parallel"==a.getEdge(b.left).role?!0:!1:!1}function cg(a,b,c,d){var e=b.graph,f={},g={},h;qa(b,c,0,f);var k=e.getEdge(c),l=e.getTail(k),m=e.getHead(k),q=e.getNode(d);h=e.getEdge(q.up);e.getHead(h);var p=Ma(e,l.id,q.id);h=q.y;p.y>h&&(h=q.y+(p.y-h),R(b,q,h,-1E7,f),h=p.y);var r=m.box.bottom+Config.METRE;h>l.box.top-Config.METRE?(c.x<p.x&&b.moveRight(m.id,p.x-c.x,f),eb(b,l.x,l.y,h,f)):h<r&&(h=q.y+
(r-h),R(b,q,h,-1E7,f),h=r);I(b,f,g);b=Utils.objectValues(g);la(a,e,k,b);e=fa(a,e,k.head,null,h,b);a=t(a.storage);G(b,a,d,e,"left");return b}function yb(a,b,c,d){var e=b.graph,f=a.storage.graph,g={},h={},k;qa(b,c,0,g);var l=e.getEdge(c),m=e.getTail(l),q=e.getHead(l),p=e.getEdge(d),r=e.getTail(p);qa(b,p.id,0,g);var y=Ma(e,m.id,r.id);k=r.box.top-Config.METRE;y.y>k&&(k=r.y+(y.y-k),R(b,r,k,-1E7,g),k=y.y);var n=q.box.bottom+Config.METRE;k>m.box.top-Config.METRE?(c.x<y.x&&b.moveRight(q.id,y.x-c.x,g),eb(b,
m.x,m.y,k,g)):k<n&&(k=r.y+(n-k),R(b,r,k,-1E7,g),k=n);I(b,g,h);b=Utils.objectValues(h);w(b,d);"address"===f.getTail(l).type?(d=b,f=e.getTail(l),b=e.getEdge(f.down),w(d,l.id),la(a,e,b,d),ca(d,f.id),H(a.storage.graph,a.render),b=d):la(a,e,l,b);p=fa(a,e,p.head,p.tail,k,b);e=fa(a,e,l.head,null,k,b);a=t(a.storage);G(b,a,p,e,"left");return b}function dg(a,b,c,d){x("transplant liana",["leftInnerLineEx",c,d]);var e=pa(a),f=pa(a);f.selection=ua();b=Ub(a,b,c);b=hb(a,b,f,!1);c=null;for(var g=0,h=b,k=h.length;g<
k;){var l=h[g];if("insert"==l.type&&"edges"==l.table&&"down"==l.fields.role){c=l.id;break}g++}g=H(a.storage.graph,a.render);d=yb(a,g,c,d);d=hb(a,d,f,!0);d=b.concat(d);b={};c={};g=[];k=0;for(l=d.length;k<l;)h=d[k],"insert"===h.type?b[h.id]=!0:"delete"===h.type&&(c[h.id]=!0),k++;k=0;for(l=d.length;k<l;)h=d[k],h.id in c&&h.id in b||g.push(h),k++;Ib(a.undo,e,g,f);return null}function ed(a,b,c,d){var e=b.graph,f={},g={},h,k;c=e.getEdge(c);var l=e.getTail(c);e.getHead(c);k=e.getNode(d);e.getEdge(k.up);
var m=Q(e,l.id,k.id);h=k.y;m.y>h&&(h=k.y+(m.y-h),R(b,k,h,-1E7,f));m=Q(e,l.id,k.id);k=m.lowId==k.id?m.x+Config.METRE:m.x;k>l.x?b.moveRight(l.id,k-l.x,f):k=l.x;Xc(b,k,l.y,h+Config.METRE,f);I(b,f,g);b=Utils.objectValues(g);la(a,e,c,b);e=fa(a,e,c.head,null,h,b);a=t(a.storage);G(b,a,d,e,"left");return b}function eg(a,b,c,d){var e=b.graph,f=a.storage.graph,g=a.render,h={},k={},l=[],m;c=e.getEdge(c);var q=e.getTail(c);e.getHead(c);var k=e.getNode(d),p=e.getEdge(k.up),r=Q(e,q.id,k.id);m=k.y;var y=f.getNode(p.head).content,
n=Y(1,g,"address",y),f=Yb(f,c.head);r.y>m&&(m=k.y+(r.y-m),p=e.getNode(p.head),R(b,k,m,p.box.right+Config.METRE,h));r=Q(e,q.id,k.id);k=r.lowId==k.id?r.x+Config.METRE:r.x;k>q.x?b.moveRight(q.id,k-q.x,h):k=q.x;Xc(b,k,q.y,m+Config.METRE,h);la(a,e,c,l);q=e.getNode(c.head).x;e=e.getNode(d);m=e.y-Config.METRE-n.h;k={};fg(b,q,m,f,n.h,h);I(b,h,k);b=Utils.objectValues(k);l=l.concat(b);b=t(a.storage);h=t(a.storage);N(l,h,q,e.y);ga(g,l,b,"address",q,m,f,n.h,y);C(a,l,c.head,b,"down",null);C(a,l,b,h,null,null);
E(a,l,d,h,"sil_floor",null);return l}function sc(a,b,c,d){var e=b.graph,f={},g={},h,k;qa(b,d,0,f);c=e.getEdge(c);var l=e.getTail(c);e.getHead(c);var m=e.getEdge(d);k=e.getTail(m);var q=Q(e,l.id,k.id);h=k.box.top-Config.METRE;q.y>h&&(h=k.y+(q.y-h),R(b,k,h,-1E7,f));q=Q(e,l.id,k.id);h=k.box.top-Config.METRE;k=q.x;k>l.x?b.moveRight(l.id,k-l.x,f):k=l.x;Xc(b,k,l.y,h+Config.METRE,f);I(b,f,g);b=Utils.objectValues(g);w(b,d);la(a,e,c,b);d=fa(a,e,m.head,m.tail,h,b);e=fa(a,e,c.head,null,h,b);a=t(a.storage);G(b,
a,d,e,"left");return b}function Hf(a,b){var c=Md(a,b);return"duration"==c.type?a.getNodeRightEx(c):c}function Rf(a,b){var c=a.getNodeLeftEx(b);return c.down?c:a.getNodeLeftEx(c)}function J(a){a=new Utils.Content(a,"");var b=Za("font"),c=m.storage.font;b&&c!=b&&(a.font=b);if(b=Za("shape"))for(var c=0,d=Object.keys(b),e=d.length;c<e;){var f=d[c],g=b[f];("number"==typeof g||g)&&(a[f]=g);c++}return a}function Y(a,b,c,d){a={id:String(a),isLine:!1,type:c,content:d,x:0,y:0};zd(a);c=Drakon.isWideIcon(a)?
Config.DEF_ICON_WIDTH:Config.DEF_ICON_WIDTH_S;a.w=c;b=Drakon.fitItem(a,b);xb(a,b);return a}function za(a,b,c){return{id:String(a),isLine:!1,x:b,y:c,w:0,h:0,type:"junction"}}function ma(a,b,c,d,e){return{id:String(a),isLine:!0,isVertical:b,head:c,tail:d,role:e,type:b?"vertical":"horizontal"}}function fg(a,b,c,d,e,f){b=Utils.boxFromPoint(b,c,0,e);a.pushObjects(b,{},d,"horizontal",f);a.pushObjects(b,{},-d,"horizontal",f)}function Qd(a){var b=a.zone;a.zone++;return b}function tc(a,b,c,d,e){var f=a.graph,
g=b.x,h=c.x,k;b.y<c.y?(k=b.y,b=c.y):(k=c.y,b=b.y);for(c=Config.SNAP;;){var l;a:{l=f;for(var m=k,q=h,p=b,r=g;;){if(!(r<q)){l=!1;break a}var n=new Utils.Box(r,m,r+Config.METRE+1,p);if(!Af(l,n)){l=!0;break a}r+=Config.SNAP}}if(l)break;a.moveRight(d,c,e);h+=c}}function Wg(a,b,c){var d=a.storage.graph.getNode(b),e=Utils.copyObject(S(d));c=c.content?c.content.txt:"";e.txt=c;return{type:"item",text:n("MES_POINT_TO")+' "'+c+'"',code:function(){ib(a,b,e)}}}function Jb(a,b,c,d){return{action:b.action,socketType:a,
itemId:b.itemId,dx:c,dy:d}}function ih(a,b){return{image:b.image,text:n(b.text),code:function(){var c=b.type;x("change type",[a,c]);var d={type:c};"raction"==c&&(c=m.storage.graph.getNode(a),c=Utils.copyObject(c.content),c.radius=8,d.content=c);d=[new z("update","nodes",a,d)];M(m,d,null)}}}function hb(a,b,c,d){b=ec(a.storage,b);$a(a,b,c,!1,d);return b}function jb(a,b,c,d){var e=b.graph,f=e.getEdge(c.down);c=e.getTail(f);if(gg(f,d))if(c.right){var g=e.getEdge(c.right);"parallel"==g.role?(a.push(d),
d=Qd(b),jb(a,b,c,d),a=e.getNode(g.tail),hg(b,a)):"par-down"==f.role?c.down&&(e=a.pop(),jb(a,b,c,e)):(ig(a,b,c,d),c.down&&(e=Qd(b),zb(a,b,c,e),jb(a,b,c,e)))}else c.down?jb(a,b,c,d):"par-down"!=f.role&&c.left&&"sil_floor"!==e.getEdge(c.left).role&&Rd(a,b,c,d)}function jg(a,b,c,d){var e=b.graph;c=e.getEdge(c.down);e=e.getTail(c);"par-down"==c.role?kb(a,b,e,d):jg(a,b,e,d)}function kb(a,b,c,d){var e=b.graph,f=e.getEdge(c.down);c=e.getTail(f);uc(f,d)&&(c.right?"parallel"==e.getEdge(c.right).role?jg(a,b,
c,d):"par-down"!=f.role&&(c.left?(e=e.getEdge(c.left),"lstick"==e.role&&(c.down?kb(a,b,c,d):c.right&&zb(a,b,c,d))):c.down?kb(a,b,c,d):c.right&&zb(a,b,c,d)):c.left?(e=e.getEdge(c.left),"lstick"==e.role&&(c.down?kb(a,b,c,d):c.right&&zb(a,b,c,d))):c.down?kb(a,b,c,d):c.right&&zb(a,b,c,d))}function Rd(a,b,c,d){var e=b.graph;c=e.getEdge(c.left);e=e.getHead(c);uc(c,d)&&(e.down?jb(a,b,e,d):e.left?Rd(a,b,e,d):e.up&&kg(a,b,e,d))}function uc(a,b){if(a.lowerMark)return!1;a.lowerMark=b;return!0}function zb(a,
b,c,d){var e=b.graph;c=e.getEdge(c.right);e=e.getTail(c);uc(c,d)&&(e.down?kb(a,b,e,d):e.right&&zb(a,b,e,d))}function ig(a,b,c,d){var e=b.graph;c=e.getEdge(c.right);e=e.getTail(c);gg(c,d)&&!e.up&&(e.right?(ig(a,b,e,d),e.down&&(d=Qd(b),zb(a,b,e,d),jb(a,b,e,d))):e.down&&jb(a,b,e,d))}function kg(a,b,c,d){var e=b.graph;c=e.getEdge(c.up);var f=e.getHead(c);uc(c,d)&&(cb(e,f)?Rd(a,b,f,d):f.up&&kg(a,b,f,d))}function gg(a,b){if(a.upperMark)return!1;a.upperMark=b;return!0}function hg(a,b){var c=a.graph,d=Qd(a);
jb([],a,b,d);b.right&&(c=c.getNodeRightEx(b),hg(a,c))}function lg(a,b,c){var d,e,f=b.getNodeDown(c);c.right?(e=Id(b,f),d=e.nodes,e=e.edges):(d={},e={},d[c.id]=!0,c=U(b,c.id),d[c.id]=!0,b.enumerateManhattan(f,d,e));b=gf(b,d,e);a=H(b,a);return dd(a.graph)}function Hb(a,b,c){CallTrace.add("Editor: "+a,[b]);var d=of(b);if(c){b=Sf(b,a);var e=J("");"raction"==c&&(e.radius=8);var f=m.render;c={id:"1",isLine:!1,type:c,content:e,x:0,y:0};c.w=b;b=Drakon.fitItem(c,f);xb(c,b);c.x=c.w;c.y=c.h;b=new Utils.LogicalTree("1");
Utils.addLogicalTreeNode(b,c);d.toInsert(b)}mg(d,a)}function wd(a,b,c){CallTrace.add("Editor: "+a,[b]);var d=of(b),e=Sf(b,a);b=c.nodes[c.root];b.w=e;e=Drakon.fitItem(b,m.render);xb(b,e);d.toInsert(c);mg(d,a)}function vc(a,b,c){var d=rc();1==d.length&&(d=d[0],D(m.storage,d),a*=Config.SNAP,b*=Config.SNAP,ng(d),og(a,b,c),Bf())}function pg(a,b,c,d){var e=a.graph,f=a.render;(a=a.free.get(b))||(a=e.getNode(b));ea.moveCanvasNode(f,b,a,c,d)}function Zc(a,b,c){var d=0;a=a.nodes;for(var e=Object.keys(a),f=
e.length;d<f;){var g=a[e[d]];g.x+=b;g.y+=c;d++}}function Vc(a){for(var b=new Utils.SortedSet,c=0,d=a.length;c<d;){var e=a[c];"insert"===e.type&&b.add(e.id,e);c++}for(var c={},d=[],f=0,g=a.length;f<g;)e=a[f],"delete"===e.type&&(e.id in b.set||d.push(e),c[e.id]=!0),f++;for(var g=0,h=a.length;g<h;)e=a[g],"update"==e.type&&(f=b.get(e.id))&&Utils.mergeSets(f.fields,e.fields),g++;f=0;for(g=a.length;f<g;)e=a[f],e.id in c||e.id in b.set||d.push(e),f++;a=0;e=b.list;for(g=e.length;a<g;)f=e[a],f in c||(f=b.get(f),
d.push(f)),a++;return d}function wc(a,b){var c=null,c=m.storage.graph,d=rc();if(0==d.length)c=Of(m);else{var e=D(m.storage,d[0]);e.isLine?c=Of(m):e.free?(c=function(a){return b(a,e)},c=Ff(m,e,c)):(c=a(c,e),c||(c=function(a){return b(a,e)},c=Ff(m,e,c)))}c&&(Fa(m,c),Sd())}function qg(a,b,c,d){var e=b.graph,f={},g=e.getEdge(c),h=e.getTail(g);c=e.getEdge(d);var k=e.getHead(c),l=Ma(e,h.id,k.id);l.x>h.x?(b.moveRight(h.id,l.x-h.x,f),l=l.x):l=h.x;eb(b,l,h.y,k.y,f);h={};I(b,f,h);b=Utils.objectValues(h);w(b,
d);la(a,e,g,b);d=fa(a,e,g.head,null,k.y,b);e=t(a.storage);a=t(a.storage);G(b,e,c.head,d,"left");G(b,a,d,c.tail,"left");return b}function rg(a,b,c,d){var e=b.graph,f={},g=e.getEdge(c),h=e.getTail(g);c=e.getEdge(d);var k=e.getHead(c),l=a.storage.graph.getEdge(d),m=Q(e,h.id,k.id);m.x>h.x?(b.moveRight(h.id,m.x-h.x,f),m=m.x):m=h.x;eb(b,m,h.y,k.y,f);h={};I(b,f,h);b=Utils.objectValues(h);w(b,d);la(a,e,g,b);d=fa(a,e,g.head,null,k.y,b);e=t(a.storage);a=t(a.storage);G(b,e,c.head,d,l.role);G(b,a,d,c.tail,l.role);
return b}function sg(a,b,c,d){var e=b.graph,f=a.render,g=a.storage.graph,h={},k=[];c=e.getEdge(c);var l=e.getTail(c),m=e.getEdge(d),q=e.getHead(m);g.getEdge(d);var p=Q(e,l.id,q.id),r=e.getNodeUp(q),r=g.getNode(r).content,g=Yb(g,c.head),n;n=Drakon.fitItem({isLine:!1,type:"address",content:r,x:0,y:0,w:g},f);p.x>l.x?(b.moveRight(l.id,p.x-l.x,h),p=p.x):p=l.x;eb(b,p,l.y,q.y,h);w(k,d);la(a,e,c,k);d=e.getNode(c.head).x;e=e.getNode(m.head);l=e.y-Config.METRE-n.h;q={};fg(b,d,l,g,n.h,h);I(b,h,q);b=Utils.objectValues(q);
k=k.concat(b);b=t(a.storage);h=t(a.storage);N(k,h,d,e.y);ga(f,k,b,"address",d,l,g,n.h,r);C(a,k,c.head,b,"down",null);C(a,k,b,h,null,null);E(a,k,m.head,h,"sil_floor",null);E(a,k,h,m.tail,"sil_floor",null);return k}function Mb(a,b){var c=Z("block");if(c){c.graph=kf(c.graph);var d=lc(c.graph);kc(a,d)&&c&&Ga(a,b,c,"paste block")}}function Ed(a,b){var c=a.render,d=a.storage.graph,e=Z("branch");if(e){x("paste branch",[b,Utils.copyObject(e)]);var f=kf(e.graph);e.graph=f;e.pgraph=H(e.graph,c);var g=d.getNode(b),
g=d.getNodeUpEx(g),h,k=null,l=!g.right,m=f.getNode(e.top),q=f.getNode(e.bottom);f.getNode(e.rBottom);var p=lg(c,d,g),r=dd(e.pgraph.graph);if(l)h=U(d,g.id);else{var n=d.getNodeRightEx(g),t=U(d,n.id),A=!t.left;A?(h=U(d,g.id),h=Ra(d,h.id)):h=d.getNodeLeftEx(t);k=lg(c,d,n)}var v=h.y-g.y,K=q.y-m.y,c=H(d,c),m={},C=vh(f,q),d=Md(d,h.id).id,z;v>K?(z=v-K,C.forEach(function(a){a.y+=z})):v<K&&(z=K-v,c.moveDown(h.id,z,m));l||(v=r.right-r.left,k=k.left-p.right,v>k&&c.moveRight(n.id,v-k,m));k={};I(c,m,k);k=Utils.objectValues(k);
l||(w(k,g.right),A||w(k,h.right));c={};c[q.group]=d;Zc(f,p.right-r.left,g.y);Zd(a,e,k,c);f=c[e.top];q=c[e.bottom];e=c[e.rBottom];E(a,k,g.id,f,null);E(a,k,h.id,q,"sil_floor");l||(E(a,k,f,n.id,null),A||E(a,k,e,t.id,"sil_floor"));M(a,k,null)}}function Rc(a,b){var c=Z("case");c&&Xf(a,b,c.content)}function Bd(a,b,c){x("paste free items",[]);var d=Z("free");if(d){for(var d=d.items,e=Number.MAX_VALUE,f=Number.MAX_VALUE,g=0,h=d.length;g<h;){var k=d[g],k=qc(k),l=k.top,e=Math.min(e,k.left),f=Math.min(f,l);
g++}g={};b=Utils.snapPos(b-e);c=Utils.snapPos(c-f);f=0;for(e=d.length;f<e;)k=d[f],h=t(a.storage),g[k.id]=h,k.id=h,k.x+=b,k.y+=c,f++;c=[];b=0;for(f=d.length;b<f;)k=d[b],k.next&&(k.next=g[k.next]),c.push(new z("insert","free",k.id,k)),b++;d=d[0].id;k=a.storage.free.list;0!=k.length&&Ca(c,"free",k[k.length-1],{next:d});d=Utils.objectValues(g);M(a,c,d)}}function Sc(a,b){var c=Z("text");if(c){var d="";c.content&&(d=c.content.txt||"");c=D(a.storage,b);c=S(c);d=xc(c,d);ib(a,b,d)}}function yc(a,b,c){var d=
0,d=d=d=0,e=a.storage,d=b.table;if("diagrams"===d)for(a=0,b=c?b.undo:b.fields,c=Object.keys(b),d=c.length;a<d;){var f=c[a];e[f]=b[f];a++}else if("nodes"===d)if(d=b.type,"insert"===d)tg(a,b,c);else if("update"===d)for(e=a.storage.graph,c=c?b.undo:b.fields,c.id=b.id,b=e.getNode(c.id),a=0,d=Object.keys(c),f=d.length;a<f;){var g=d[a],h=c[g];if(e.nonUpdatable[g]){Utils.throwError("Field '"+g+"' cannot be updated.");break}b[g]=h;a++}else{if("delete"!==d)throw"Unexpected switch value: "+d;ug(e,b,c)}else if("free"===
d)if(d=b.type,"insert"===d)e=a.storage.free,c?e.remove(b.id):(c=La(b.fields),c.id=b.id,e.add(b.id,c));else if("update"===d)for(e=a.storage.free,c=c?b.undo:b.fields,c.id=b.id,b=e.get(c.id),e=0,a=Object.keys(c),d=a.length;e<d;)f=a[e],b[f]=c[f],e++;else{if("delete"!==d)throw"Unexpected switch value: "+d;e=e.free;c?(c=La(b.undo),c.id=b.id,e.add(b.id,c)):e.remove(b.id)}else{if("edges"!==d)throw"Unexpected switch value: "+d;d=b.type;if("insert"===d)tg(a,b,c);else{if("delete"!==d)throw"Unexpected switch value: "+
d;ug(e,b,c)}}}function Yc(a,b,c){var d=b.length;if(c)for(c=d-1;0<=c;)yc(a,b[c],!0),c--;else for(c=0;c<d;)yc(a,b[c],!1),c++}function Ef(a,b,c){var d=a.storage.graph.checkEdges();if(d)Utils.throwError(d);else{var e=a.storage.free,d=new Utils.SortedSet;(e=df(e.set,d))?d=e:(a.storage.free=d,d=null);d?Utils.throwError(d):c&&(a.storage.selection=nc(b.selection),Nc(),na(a))}}function pb(a,b){for(var c=m.storage.persistence,d=0,e=a.length;d<e;){var f=c,g=a[d],h=b,k=0,k=0,k=g.table;if("diagrams"===k)k=void 0,
k=h?g.undo:g.fields,f.updateDiagram(k);else if(k=g.type,"insert"===k)h?f.remove(g.id):(h=La(g.fields),h.id=g.id,f.add(h));else if("update"===k)k=h?g.undo:g.fields,k.id=g.id,f.update(k);else{if("delete"!==k)throw"Unexpected switch value: "+k;h?(h=La(g.undo),h.id=g.id,f.add(h)):f.remove(g.id)}d++}c.persist()}function pf(a,b,c){b=Wc(a,b);var d;for(d=b.length-1;0<d;){var e=b[d];c.nodes[e.id]=!0;c.edges[e.left]=!0;c.edges[e.down]=!0;e=a.getNodeDown(e);Da(a,e,c);d--}}function Da(a,b,c){var d=0,e=a.getNode(b);
if(e.down){var f=a.getNodeDown(e),d=e.type;if("question"===d)c.nodes[b]=!0,c.edges[e.down]=!0,e=e.right,b=a.getEdge(e),b=a.getTail(b),c.edges[e]=!0,he(a,b)?Sb(a,b,c):"left-t"===v(b)?b.id in c.stairs?(delete c.stairs[b.id],e=a.getNodeDown(b),c.edges[b.down]=!0,c.nodes[b.id]=!0,Da(a,e,c,!1)):L(a,b,c):(e=a.getNodeDown(b),c.edges[b.down]=!0,c.nodes[b.id]=!0,Da(a,e,c,!1)),Da(a,f,c);else if("select"===d){var d=a.getNode(f),g=a.getNodeDown(d);c.nodes[b]=!0;c.nodes[f]=!0;c.edges[e.down]=!0;c.edges[d.down]=
!0;pf(a,b,c);Da(a,g,c)}else"junction"===d?"left-t"===v(e)?(d=a.getNodeLeft(e),"question"===a.getNode(d).type?c.stairs[b]=!0:(c.nodes[b]=!0,c.edges[e.down]=!0,Da(a,f,c))):(c.nodes[b]=!0,c.edges[e.down]=!0,Da(a,f,c)):(c.nodes[b]=!0,c.edges[e.down]=!0,Da(a,f,c))}else if(c.nodes[b]=!0,"junction"===e.type)if(e.left)if(e.right){f=a.getNodeRight(e);a:for(;;){b=a.getNode(f);if(!(f in c.nodes)){f=!0;break a}if(!b.right){f=!1;break a}f=a.getNodeRight(b)}f?oc(a,e,c,"left","right",c.horHoles):(f=a.getNodeLeft(e),
f=a.getNode(f),c.edges[e.left]=!0,L(a,f,c))}else f=a.getNodeLeft(e),f=a.getNode(f),c.edges[e.left]=!0,L(a,f,c);else e.right&&(f=a.getNodeRight(e),f=a.getNode(f),b=a.getEdge(e.right),c.edges[e.right]=!0,he(a,f)?Sb(a,f,c):"right"===b.role?sf(a,f,c):L(a,f,c))}function oc(a,b,c,d,e,f){var g=b.id,h=b[d];b=b[e];h&&b&&(c.nodes[g]=!0,c.edges[h]=!0,c.edges[b]=!0,c=a.getEdge(h).head,a=a.getEdge(b).tail,f[g]={up:c,down:a,dir:d})}function L(a,b,c){oc(a,b,c,"up","down",c.verHoles)}function zc(a,b){var c=a.canvas.sockets[b];
Tb(a);na(a);a.dirty=!0;return c}function ja(a,b,c){var d=0;if(b.id in c)return!0;c[b.id]=!0;d=b.type;return"beginend"===d||"end"===d?!0:"junction"===d?Eh(a,b,c):"question"===d?(d=a.getNodeRight(b),d=a.getNode(d),d=!d.down||d.up||ja(a,d,c)?!0:!1,d?(b=a.getNodeDown(b),b=a.getNode(b),ja(a,b,c)):!1):"select"===d?(d=Ue(a,b,c))?(b=a.getNodeDown(b),b=a.getNode(b),b=a.getNodeDown(b),b=a.getNode(b),ja(a,b,c)):!1:b.down?(b=a.getNodeDown(b),b=a.getNode(b),ja(a,b,c)):!0}function Eh(a,b,c){return"right-t"===v(b)?
a.getNodeRight(b)in c||"arrow"===a.getEdge(b.right).role?b.down?(b=a.getNodeDown(b),b=a.getNode(b),ja(a,b,c)):!0:!1:b.down?(b=a.getNodeDown(b),b=a.getNode(b),ja(a,b,c)):!0}function Ue(a,b,c){b=Wc(a,b.id);var d;for(d=b.length-1;;){if(!(0<d))return!0;var e=a.getNodeDown(b[d]),e=a.getNode(e);if(!ja(a,e,c))return!1;d--}}function af(a,b,c,d){a.moveRight(b.id,b.x<c&&"duration"!=b.type?c-b.box.right-Config.METRE:c-b.box.left+Config.METRE,d)}function w(a,b){var c=new z("delete","edges",b,null);a.push(c)}
function ca(a,b){var c=new z("delete","nodes",b,null);a.push(c)}function rf(a,b,c){var d=a.getNode(c);if(a=Drakon.getDuration(a,d))w(b,d.left),ca(b,a.id);ca(b,c)}function Qb(a,b,c){var d=0;c=Object.keys(c);for(var e=c.length;d<e;)w(a,c[d]),d++;d=0;b=Object.keys(b);for(c=b.length;d<c;)ca(a,b[d]),d++}function vb(a,b,c,d){Aa(a,b,c,d,"down")}function X(a,b,c,d,e,f,g,h,k){var l=Y(1,a,d,k);a=Drakon.fitItem(l,a);b.push(new z("insert","free",c,{id:c,type:d,free:!0,x:e,y:f,w:g,h:h,a:a.a,tb:a.tb,tb2:a.tb2,
content:k}))}function G(a,b,c,d,e){b=new z("insert","edges",b,{type:"horizontal",isVertical:!1,isLine:!0,head:c,tail:d,role:e});a.push(b)}function N(a,b,c,d){Ya(a,b,{type:"junction",x:c,y:d,w:0,h:0})}function Ya(a,b,c){var d={type:c.type,isLine:!1,x:c.x,y:c.y,w:c.w,h:c.h,a:c.a,content:c.content,flag1:c.flag1,role:c.role};c.tb&&(d.tb=c.tb);c.tb2&&(d.tb2=c.tb2);a.push(new z("insert","nodes",b,d))}function ga(a,b,c,d,e,f,g,h,k){d={id:c,type:d,x:e,y:f,w:g,h:h,content:k};zd(d);a=Drakon.fitItem(d,a);xb(d,
a);Ya(b,c,d)}function Aa(a,b,c,d,e){b=new z("insert","edges",b,{type:"vertical",isVertical:!0,isLine:!0,head:c,tail:d,role:e});a.push(b)}function Ca(a,b,c,d){a.push(new z("update",b,c,d))}function vg(a,b){a.push(new z("update","diagrams","diagram",{name:b}))}function ge(a,b){var c=a.getNodeLeft(b);return"question"==a.getNode(c).type?!0:!1}function Xc(a,b,c,d,e){var f=a.graph;d+=Config.METRE;for(var g=Math.floor(c+Config.METRE/2),h=b-1,k=b+Config.METRE;;){c+=Config.METRE;if(c>=d)break;for(var l=new Utils.Box(h,
g,k,c),m=0,q=f.items,p=Object.keys(q),r=p.length;m<r;){var n=q[p[m]];if(Utils.boxesIntersect(l,n.box)&&!n.isVertical){if(n.isLine){a.moveDown(n.tail,Config.METRE,e);break}if(n.x!=b){af(a,n,b,e);break}}m++}}}function Cf(a,b){a.grips=[];for(var c=[],d=Object.keys(b),e=0,f=d.length;e<f;){var g=a,h=d[e],k=c,l=D(g.storage,h),g=g.grips,m={x:l.x,y:l.y,w:l.w,h:l.h};if(l.free){for(var q=ea.getCandies(l),p=q,r=0,n=p.length;r<n;){var t=p[r];k.push({x:t.x,y:t.y,id:t.id});r++}Lc(g,h,q,m);l=ea.getHandles(l);Lc(g,
h,l,m)}else l.isLine||"duration"==l.type||"end"==l.type||("junction"==l.type?qd(g,h,l.x,l.y,Const.DRN_MOVE,m):(q=ea.getCandies(l),Lc(g,h,q,m)));e++}e=c.length;h=f=1E7;l=-1E7;if(0==e)c=null;else{for(g=0;g<e;)m=c[g],h=Math.min(h,m.x),l=Math.max(l,m.x),f=Math.min(f,m.y),g++;c=new Utils.Point((h+l)/2,f-30)}c&&(e=null,1==d.length&&(e=d[0]),qd(a.grips,e,c.x,c.y,Const.DRN_MOVE_ALL,{}));lb=c}function Vb(a,b){var c=a.box,d=c.right,c=c.bottom;d>b.x&&(b.x=d);c>b.y&&(b.y=c,b.lowId=a.id)}function Sd(){na(m)}function na(a){try{wg(a,
null)}catch(b){throw CallTrace.error(b),b;}}function wg(a,b){a.render.clear();a.canvas=new qe(a.render);a.render.setBackground(a.storage.background);ea.setDiaLine(a.storage.diaLine,a.storage.diaLineThickness);vf(a.storage,a.canvas);var c=fc(a);Cf(a,c);ea.drawCandies(a.canvas.graph,a.canvas.free,a.render,c);se=lb?a.render.createMoveAll(lb.x,lb.y,"free_candies"):null;var d;a:{var e=a.storage.selection;if(e&&e.ids){var f=Object.keys(e.ids);if(1==f.length){var g=f[0];d="green"==e.ids[g]?g:null;break a}}d=
null}var h;if(d){if(!ia()){var k=a.canvas,l=k.graph;if(0!=Object.keys(l.nodes).length){if(re(l)){k.zone=1;for(var u=0,q=l.nodes,p=Object.keys(q),r=p.length;u<r;){var n=p[u],t=q[n];if("branch"===t.type){var A=Qd(k),w=[];jb(w,k,t,A)}u++}}else{var x;a:{for(var C=0,z=l.nodes,E=Object.keys(z),I=E.length;;){if(!(C<I)){Utils.throwError("Head not found");break}var H=z[E[C]];if("header"===H.role){x=H;break a}C++}x=void 0}k.zone=2;var w=[];jb(w,k,x,1)}for(var D=0,F=l.nodes,G=Object.keys(F),M=G.length;D<M;){n=
G[D];t=F[n];if("junction"===t.type){var N=v(t),J;"left-down"===N?(J=l.getEdge(t.down),t.mark=J.upperMark):"left-up"===N?(J=l.getEdge(t.up),t.mark=J.upperMark):"right-down"===N?(J=l.getEdge(t.right),t.mark=J.lowerMark):"right-up"===N&&(J=l.getEdge(t.up),t.mark=J.lowerMark)}D++}if(Config.SHOW_ZONES){k.zoneColors={};for(var U=k.graph,O=0,Y=U.edges,P=Object.keys(Y),V=P.length;O<V;){var S=P[O],ca=Y[S];wf(k,ca,!0);wf(k,ca,!1);O++}for(var Q=0,X=U.nodes,fa=Object.keys(X),la=fa.length;Q<la;){var S=fa[Q],ga=
k,W=X[S];if(W.mark){var ma=xf(ga,W.mark);ga.render.createAction(W.x,W.y,10,10,ma,"black","line_candies")}Q++}}}}var B=a.canvas.graph,T;if(!m.readonly&&d in B.items){var L=yh(B,d);if(L){a.transplantSource=L;var R=B.getItem(L);R.isLine||(L=R.up);if("address"===R.type){for(var na=[],pa=B.getEdge(L),ka=0,ta=B.edges,ua=Object.keys(ta),Aa=ua.length;ka<Aa;){var ja=ta[ua[ka]];sb(ja)&&ja.upperMark===pa.lowerMark&&!pc(B,pa.tail,ja.tail)&&dc(na,ja.id,"leftInnerLine");ka++}T=na}else if(Xe(B,R)){for(var wa=[],
qa=0,za=B.edges,Ba=Object.keys(za),La=Ba.length;qa<La;){var Da=Ba[qa],ya=za[Da];if("down"==ya.role||"par-down"==ya.role){var Z=B,Ca=R,ra=ya;if(ra.upperMark==Ca.lowerMark){var Ra=Z.getHead(Ca),Sa=Z.getTail(Ca),Wa=Z.getHead(ra),Xa=Z.getTail(ra);if(ke(Z,ra)||Wa.y<Ra.y)joinType=null;else{var Ya=Z.getNodeDown(Sa);joinType=pc(Z,Ya,ra.tail)||le(Z,Xa)?null:"leftInnerLineEx"}}else joinType=null;joinType&&dc(wa,Da,joinType)}qa++}T=wa}else{var Pa=L,Qa=B.getEdge(Pa),mb={};if(Qa.isVertical){var Ab=B.getTail(Qa);
if(Ab.left&&!ge(B,Ab)){mb[Ab.left]=!0;var bb=B.getEdge(Ab.left),va=B.getHead(bb);mb[va.id]=!0;Utils.addNotNilToSet(mb,va.down);Oc(Ab)||Oc(va)||"junction"!==va.type||Utils.addNotNilToSet(mb,va.up)}if(Ab.right){mb[Ab.right]=!0;var eb=B.getEdge(Ab.right),Ea=B.getTail(eb);mb[Ea.id]=!0;Utils.addNotNilToSet(mb,Ea.down);Oc(Ab)||Oc(Ea)||Utils.addNotNilToSet(mb,Ea.up)}var gb=B.getVertical(Pa),qb=Utils.listToSet(gb);Utils.mergeSets(mb,qb)}var Ka;var vb=B.getEdge(L),Ma=B.getTail(vb);if("junction"===Ma.type){var ib=
v(Ma);if("right-up"===ib){var zb=B.getNodeRight(Ma),Ib=B.getNode(zb);Ka="left-up"===v(Ib)?"arrow":null}else Ka="left-up"===ib&&ge(B,Ma)?"sq":null}else Ka=null;var Za;if(Ye(B,R)){var $a=[],rb=B.getEdge(L),Kb=Md(B,rb.head),Nb=B.getEdge(Kb.down),Qb=B.getNode(rb.head),Tb=B.getEdge(Qb.up);dc($a,Tb.id,"leftInnerLineTs");dc($a,Nb.id,"leftOuterLineTs");Za=$a}else{var fb;if(Ze(B,R)){var wb=[],Vb=B.getEdge(L),Xb=B.getNode(Vb.head),Yb=B.getNodeDownEx(Xb);dc(wb,Yb.id,"leftOuterCornerTs");fb=wb}else{var Fa=Ka,
Ga=0,hb=[],Bb=B.getEdge(L),Ac;var yb=B.getTail(Bb);Ac="junction"===yb.type?"left-t"===v(yb)?!0:!1:!1;for(var kb=0,Hb=B.items,Lb=Object.keys(Hb),hc=Lb.length;kb<hc;){var Ta=Hb[Lb[kb]],Bc=null;if(!(Ta.id in mb))if(Ta.isLine)if(Ga=Ta.role,"down"===Ga||"par-down"===Ga){var ha=B,Cb=Bb,sa=Ta,ic=Ac,ab=Fa,fd=null,kc=ha.getHead(Cb),tb=ha.getTail(Cb),ub=ha.getHead(sa),db=ha.getTail(sa),Wb=ie(ha,tb.id);if(ic)sa.upperMark!==Cb.lowerMark||ke(ha,sa)||ub.y<Wb.y||pc(ha,Cb.tail,sa.tail)||le(ha,db)||(fd="leftInnerLine");
else if(sa.upperMark===Cb.lowerMark)ke(ha,sa)||ub.y<Wb.y||pc(ha,Cb.tail,sa.tail)||"sq"==ab||le(ha,db)||(fd="leftInnerLine");else if(sa.lowerMark===Cb.upperMark){var xb;if(xb=ub.x>kc.x&&!Df(ha,sa.tail)){var Fb;a:for(var Db=ha,ac=sa.id,Gb=0,cc=Db.getEdge(ac),Ua=Db.getHead(cc);;){var pb,ec;ec=Ua.right?"arrow"===Db.getEdge(Ua.right).role?!0:!1:!1;if(pb=ec)b:for(var Cc=Db,Pc=ac,Rc=Cc.getNodeRight(Ua),Tc=Cc.getNode(Rc),Uc=Cc.getNodeDown(Tc),gd=Cc.getNode(Uc),Mb=void 0;;){if(gd.left)Mb=Cc.getNodeLeft(gd);
else{if(!gd.up){pb=!1;break b}if(gd.up==Pc){pb=!0;break b}Mb=Cc.getNodeUp(gd)}gd=Cc.getNode(Mb)}if(pb){Fb=!0;break a}if(!Ua.up){for(var Ob=0,Ua=Db.getHead(cc);;){Gb=Ua.type;"loopbegin"===Gb?Ob--:"loopend"===Gb&&Ob++;if(!Ua.up)break;var Pb=Db.getNodeUp(Ua),Ua=Db.getNode(Pb)}Fb=0===Ob?!1:!0;break a}Pb=Db.getNodeUp(Ua);Ua=Db.getNode(Pb)}xb=!Fb}if(xb&&!ab){var Xc=fe(ha,sa.head);tb.y>Xc.y&&(fd="rightLine")}}else sa.upperMark===Cb.upperMark&&db.y>tb.y&&!ke(ha,sa)&&!je(ha,Cb.tail,sa.tail)&&!le(ha,db)&&(ab?
"sq"==ab&&(fd="shortCycleDown"):fd="leftOuterLine");Bc=fd}else if("left"===Ga){if(!Ac&&!Fa){var nc=B,Rb=Bb,Sb=Ta,Ub=null,cd=nc.getTail(Rb),dd=nc.getTail(Sb);cd.y<dd.y&&(Sb.upperMark===Rb.lowerMark?Ub="onInnerFloor":Sb.upperMark===Rb.upperMark&&(Ub="onOuterFloor"));Bc=Ub}}else if("sil_floor"===Ga){if(!Ac&&!Fa){var qc=B,rc=Bb,tc=Ta,uc=null;qc.getTail(rc);qc.getTail(tc);tc.upperMark===rc.upperMark&&(uc="onOuterSilFloor");Bc=uc}}else{if("right"===Ga&&!Ac&&!Fa){var vc=B,wc=Bb,xc=Ta,Kc=null,nd=vc.getTail(wc),
od=vc.getTail(xc);nd.y<od.y&&xc.upperMark===wc.upperMark&&(Kc="onOuterFloor");Bc=Kc}}else if("junction"===Ta.type&&Ta.mark&&!Ac&&!Fa){var Ha=B,Va=Bb,aa=Ta,hd=null;if(!he(Ha,aa)){var Td=Ha.getTail(Va),bc=v(aa),qd=fe(Ha,Va.head);if(aa.y>qd.y)if("left-up"===bc){var Lc=Ha.getEdge(aa.left),Mc=Ha.getEdge(aa.up);aa.mark===Va.upperMark?aa.y>Td.y&&!je(Ha,Va.tail,aa.id)&&"par-down"!=Mc.role&&(hd="sil_floor"===Lc.role?"leftOuterCornerSil":"leftOuterCorner"):aa.mark===Va.lowerMark&&aa.x<Td.x&&!pc(Ha,Va.tail,
aa.id)&&"par-down"!=Mc.role&&"sil_floor"!==Lc.role&&(hd="leftInnerCorner")}else if("left-down"===bc){var sd=Ha.getEdge(aa.down);sb(sd)&&(aa.mark===Va.upperMark?aa.y>Td.y&&!je(Ha,Va.tail,aa.id)&&(hd="topOuterCorner"):aa.mark!==Va.lowerMark||pc(Ha,Va.tail,aa.id)||(hd="topInnerCorner"))}else"right-up"===bc&&aa.mark===Va.upperMark&&aa.x>Td.x&&"right"===Ha.getEdge(aa.right).role&&bg(Ha,Td.id)&&bg(Ha,aa.id)&&(hd="rightCorner")}Bc=hd}Bc&&dc(hb,Ta.id,Bc);kb++}if(!Ac&&!Fa){var td=B.getTail(Bb);if("right-up"!==
v(td))for(var Nc=ie(B,Bb.tail),gc=0,Qc=Gf(B,Nc,Bb.upperMark),Ed=Qc.length;gc<Ed;){var Sc=Qc[gc],jc;a:for(var id=B,Fd=Nc,Gd=id.getEdge(Sc),Vc=id.getTail(Gd),Dc=Fd;;)if(cb(id,Dc))Dc=Hf(id,Dc.id);else{if(Dc.id==Vc.id){jc=!1;break a}if(Dc.x<Vc.x){jc=!0;break a}var Hd=id.getNodeUp(Dc),Dc=id.getNode(Hd)}jc||dc(hb,Sc,"createCycle");gc++}}fb=hb}Za=fb}T=Za}}else T=[]}else T=[];h=T}else if(b)if(Utils.startsWith(b,"mind-")){var lc=a.canvas.graph,Wc=b.split("-"),Ud,Vd,me=[];"clip"==Wc[1]?(Ud="paste",Vd=""):(Ud=
"insert",Vd=Wc[1]);for(var mc=0,Yc=lc.edges,Zc=Object.keys(Yc),Id=Zc.length;mc<Id;){var $c=Yc[Zc[mc]],jd=ee(m,$c);0!=jd.length&&ye(me,$c,Ud,Vd,jd);mc++}for(var oc=0,ad=lc.nodes,bd=Object.keys(ad),Jd=bd.length;oc<Jd;){var ne=ad[bd[oc]],jd=ee(m,ne);if(0!=jd.length)if("junction"==ne.type)ye(me,ne,Ud,Vd,jd);else for(var Kd=lc,Ld=me,Nd=ne,Od=Ud,Pd=Vd,ed=jd,sc=0,Rd=ed.length;sc<Rd;){var Sd=Kd,Ec=Ld,ba=Nd,Fc=Od,Gc=Pd,Zb=ed[sc],nb=0,Na=0,Oa=0,oe=Config.METRE/2,nb=Zb.action;if("miv01"===nb){var Na=-ba.w+1.5*
Config.METRE,Oa=ba.h,Ia=Jb(Gc,Zb,Na,Oa);oa(Ec,ba.id,Ia,Fc)}else"miv04"===nb?(Na=-ba.w,Oa=ba.h,Ia=Jb(Gc,Zb,Na,Oa),oa(Ec,ba.id,Ia,Fc)):"mih02"===nb||"mih03"===nb?(Na=ba.w+oe,Ia=Jb(Gc,Zb,Na,Oa),oa(Ec,ba.id,Ia,Fc)):"mih04"===nb||"mih05"===nb?(Na=-ba.w-oe,Ia=Jb(Gc,Zb,Na,Oa),oa(Ec,ba.id,Ia,Fc)):"mih01"===nb?(Na=0,Oa=ba.h,Ia=Jb(Gc,Zb,Na,Oa),oa(Ec,ba.id,Ia,Fc)):"miv03"===nb?ba.up||"header"==ba.role||(Oa=-ba.h-oe,Ia=Jb(Gc,Zb,Na,Oa),oa(Ec,ba.id,Ia,Fc)):"miv02"===nb&&ba.left&&!Sd.getNodeLeftEx(ba).down&&(Oa=
ba.h+oe,Ia=Jb(Gc,Zb,Na,Oa),oa(Ec,ba.id,Ia,Fc));sc++}oc++}h=me}else{var Eb=a.canvas.graph,yc=b.split("-"),zc,Ic;2==yc.length&&"clip"==yc[0]?(zc="paste",Ic=yc[1]):(zc="insert",Ic=b);var Ja=Ic,Hc=zc,$b=[];if("branch"===Ja||"case"===Ja)for(var Jc=0,kd=Eb.edges,ld=Object.keys(kd),Yd=ld.length;Jc<Yd;){var Wd=ld[Jc],xa=kd[Wd];if(xa.isVertical){var md=Eb,pd=xa,rd=md.getNode(pd.head);"junction"==rd.type&&"left-down"==v(rd)&&"case"==md.getNode(pd.tail).type&&"case"==Ja&&oa($b,xa.id,Ja,Hc)}else{var ud=de(Eb,
xa);ud&&ud.type==Ja&&oa($b,xa.id,Ja,Hc)}Jc++}else if("duration"===Ja)for(var te=0,vd=Eb.nodes,wd=Object.keys(vd),Zd=wd.length;te<Zd;){var pe=wd[te],Xd=vd[pe],ob=0,ob=Xd.type;"action"!==ob&&"select"!==ob&&"question"!==ob&&"shelf"!==ob&&"input"!==ob&&"output"!==ob&&"sinput"!==ob&&"soutput"!==ob&&"insertion"!==ob||Xd.left||oa($b,pe,Ja,Hc);te++}else if("path"===Ja){for(var ue=0,xd=Eb.edges,yd=Object.keys(xd),$d=yd.length;ue<$d;)Wd=yd[ue],xa=xd[Wd],xa.isVertical||"parallel"!=xa.role||oa($b,xa.id,Ja,Hc),
ue++;for(var ve=0,zd=Eb.nodes,Ad=Object.keys(zd),ae=Ad.length;ve<ae;)pe=Ad[ve],Xd=zd[pe],Me(Eb,Xd)&&oa($b,Xd.id,Ja,Hc),ve++}else for(var we=0,Bd=Eb.edges,Cd=Object.keys(Bd),be=Cd.length;we<be;)Wd=Cd[we],xa=Bd[Wd],sb(xa)?oa($b,xa.id,Ja,Hc):Utils.canInsertInHorizontal(Eb,xa)&&oa($b,xa.id,Ja,Hc),we++;h=$b}else h=[];for(var xe=0,Dd=h,ce=Dd.length;xe<ce;)Wf(a.canvas,Dd[xe]),xe++;a.canvas.pgraph.rebuildCache()}function xg(a,b){var c=a.content;c&&(c=c.font)&&(b[c]=!0)}function yg(a,b,c){var d=a.storage.graph,
e=d.getNode(b).content,d=Dd(d,"type","address");b=[b];for(var f=0,g=d.length;f<g;){var h=d[f],k=h.content;(k?e&&k.txt==e.txt&&k.txt2==e.txt2:!e)&&b.push(h.id);f++}Fh(a,b,c)}function zg(a,b,c,d){var e=b.graph,f={},g,h=e.getEdge(c);g=e.getTail(h);e.getHead(h);var k=e.getNode(d);qa(b,c,0,f);var l=Ma(e,d,g.id);c=g.box.top-Config.METRE;c<l.y&&(c=l.y-c,R(b,g,g.y+c,-1E7,f),c=l.y);var l=k.y,m=new Utils.Point(g.x,c),k=new Utils.Point(k.x,l);c<l?(tc(b,m,k,d,f),b.moveDown(g.id,l-c,f),g=l):(c>l&&(tc(b,m,k,d,
f),b.moveDown(d,c-l,f)),g=c);k={};I(b,f,k);b=Utils.objectValues(k);la(a,e,h,b);e=fa(a,e,h.head,null,g,b);a=t(a.storage);G(b,a,e,d,"right");return b}function Ag(a,b,c,d){var e=b.graph,f={},g,h=e.getEdge(c);g=e.getTail(h);var k=e.getHead(h),l=e.getEdge(d),m=e.getHead(l),q=e.getTail(l);qa(b,c,0,f);qa(b,d,0,f);var p=Ma(e,q.id,g.id),r=g.box.top-Config.METRE;r<p.y&&(r=p.y-r,R(b,g,g.y+r,-1E7,f),r=p.y);var p=m.box.bottom+Config.METRE,n=q.box.top-Config.METRE;if(r<p){var v=new Utils.Point(g.x,r),A=new Utils.Point(q.x,
p);tc(b,v,A,m.id,f);b.moveDown(g.id,p-r,f);g=p}else r>n&&(v=new Utils.Point(g.x,r),A=new Utils.Point(q.x,n),tc(b,v,A,m.id,f),b.moveDown(q.id,r-n,f)),g=r;m={};I(b,f,m);b=Utils.objectValues(m);w(b,d);la(a,e,h,b);l=fa(a,e,l.head,l.tail,g,b);e=fa(a,e,h.head,null,g,b);h=t(a.storage);G(b,h,e,l,null);if($c(k)){x("transplant liana - right line",[c,d]);a:for(c=0,d=b.length;;){if(!(c<d)){c=null;break a}k=b[c];if("insert"==k.type&&"edges"==k.table&&k.fields.tail==e&&"down"==k.fields.role){c=k.id;break a}c++}Rb(a,
b,c);return null}return b}function Rb(a,b,c){if(c){var d=pa(a),e=pa(a);e.selection=ua();b=hb(a,b,e,!0);var f=a.storage.graph,g=f.getEdge(c);Nb(f,g)?(c=cf(a,c),c=hb(a,c.commandList,e,!0)):c=[];b=b.concat(c);b=Vc(b);Ib(a.undo,d,b,e)}else M(a,b,null)}function ug(a,b,c){a=a.graph;c?(c=La(b.undo),c.id=b.id,a.addItem(c)):a.removeItem(b.id)}function tg(a,b,c){a=a.storage.graph;c?a.removeItem(b.id):(c=La(b.fields),c.id=b.id,a.addItem(c))}function mg(a,b){var c=a[b].apply(a);c&&(m.storage.nextId=c.nextId,
M(m,c.commands,null))}function xd(a,b,c){for(var d=m.storage.graph,e=null,f=0,g=d.nodes,h=Object.keys(g),k=h.length;f<k;){var l=h[f],u=g[l];u.type==b&&(l=Drakon.fitItem(u,m.render),e=null==e?l.h:Math.max(e,l.h));f++}f=0;g=d.nodes;h=Object.keys(g);for(k=h.length;f<k;){l=h[f];u=g[l];if(u.type==b&&e!=u.h){for(var f=H(d,m.render),g={},h=0,d=d.nodes,k=Object.keys(d),q=k.length;h<q;)l=k[h],u=d[l],u.type==b&&c(f,l,e,g),h++;$d(a,g);break}f++}}function Wb(a,b,c,d,e){c=b.getNodeDown(c);var f=b.getNode(c);c!=
d&&(Vb(f,e),f.right?cb(b,f)?Xb(a,b,f,d,e):Ld(a,b,f,d,e):f.down?Wb(a,b,f,d,e):f.left&&Xb(a,b,f,d,e))}function Xb(a,b,c,d,e){var f=b.getNodeLeft(c);c=b.getNode(f);Vb(c,e);if(c.x<a){var g=b.getNode(d);c.y>g.y||f==d||(c.down?Wb(a,b,c,d,e):c.left?(f=b.getNodeLeftEx(c),"duration"==f.type?Fb(a,b,c,d,e):Xb(a,b,c,d,e)):Fb(a,b,c,d,e))}else f!=d&&(c.down?Wb(a,b,c,d,e):c.left?(f=b.getNodeLeftEx(c),"duration"==f.type?Fb(a,b,c,d,e):Xb(a,b,c,d,e)):Fb(a,b,c,d,e))}function Ld(a,b,c,d,e){c=b.getNodeRight(c);var f=
b.getNode(c),g=v(f);c!=d&&"left-up"!==g&&(Vb(f,e),c!=d&&(f.right?Ld(a,b,f,d,e):Wb(a,b,f,d,e)))}function uh(a,b,c,d){for(var e="left",f;;){d(b);if(c==b.id)break;if("down"===e)b.right?(e="right",f=a.getNodeRight(b)):b.down?f=a.getNodeDown(b):cb(a,b)?(e="left",f=a.getNodeLeft(b)):Utils.throwError("dead end");else if("right"===e)b.up?Utils.throwError("dead end"):b.right?f=a.getNodeRight(b):b.down?(e="down",f=a.getNodeDown(b)):Utils.throwError("dead end");else if("up"===e)cb(a,b)?(e="left",f=a.getNodeLeft(b)):
b.up?f=a.getNodeUp(b):Utils.throwError("dead end");else{if("left"!==e)throw"Unexpected switch value: "+e;b.down?(e="down",f=a.getNodeDown(b)):cb(a,b)?f=a.getNodeLeft(b):b.up?(e="up",f=a.getNodeUp(b)):Utils.throwError("dead end")}b=a.getNode(f)}}function Fb(a,b,c,d,e){c=b.getNodeUp(c);var f=b.getNode(c);Vb(f,e);c!=d&&(cb(b,f)?Xb(a,b,f,d,e):Fb(a,b,f,d,e))}function Fa(a,b){var c=D(a.storage,b);console.log(b,c);a.storage.selection=ua();c&&a.storage.selection.add(b,!0)}function Bg(a,b){a.storage.selection=
ua();for(var c=0,d=b.length;c<d;)a.storage.selection.add(b[c],!1),c++}function td(a,b){F()||(x("setContent",[a,b]),ib(m,a,b))}function Ic(a,b,c){x("set text for many items",b);var d=pa(a),e=pa(a),f,g=b.length,h=[];for(f=0;f<g;){var k=b[f],l=D(a.storage,k),l=c(l),h=Cg(a,k,l,h);f++}Ef(a,e,!0);Ib(a.undo,d,h,e);Bg(a,b)}function xc(a,b){var c=Utils.copyObject(a);c.txt=b;return c}function xb(a,b){a.w=b.w;a.h=b.h;"a"in b&&(a.a=b.a);b.tb&&(a.tb=b.tb);b.tb2&&(a.tb2=b.tb2)}function ib(a,b,c){c=Dg(c);x("set item text",
[b,Utils.copyObject(c)]);var d={},e=H(a.storage.graph,a.render);Eg(a,e,b,c,d);d=Utils.objectValues(d);"header"==D(a.storage,b).role&&c.txt&&vg(d,c.txt);qb(a,d,null,!1,!0)}function Eg(a,b,c,d,e){var f=a.render,g=a.storage.free;a=D(a.storage,c);e={commands:e};a.free?Drakon.changeFreeItem(f,g,c,a.w,a.h,d,e):ia()?Mind.changeItem(f,b,c,a.w,d,e):Drakon.changeItem(f,b,c,a.w,d,e);e.tb&&(a.tb=e.tb);e.tb2&&(a.tb2=e.tb2)}function ff(a){var b,c=a.length-1;for(b=0;b<c;)a[b].next=a[b+1].id,b++;0<a.length&&(a[c].next=
"")}function gb(a,b,c){(a=a[b])&&(c[b]=a)}function Jc(a,b,c,d){b in a&&(c[d||b]=a[b])}function Fg(a,b){for(var c={},d=!0,e=0,f=b.length;e<f;){var g=b[e],h=Za(g);h&&(c[g]=h,d=!1);e++}d||a.push(new z("update","diagrams","diagram",c))}function Gg(a,b){a.render.clear();a.sockets=[];a.undo=new nd;a.storage=b}function Cg(a,b,c,d){c=Dg(c);var e=a.storage.graph,f=a.render,g={},h=D(a.storage,b);h.down||"beginend"!=h.type||ia()||(Drakon.getOrCreateUpdate(g,b).fields.type="end",h.type="end");e=H(e,f);Eg(a,e,
b,c,g);b=Utils.objectValues(g);0!=b.length&&(b=ec(a.storage,b),Yc(a,b,!1),d=d.concat(b));return d}function Fh(a,b,c){Ic(a,b,function(a){a=S(a);a=Utils.copyObject(a);a.txt=c.txt;a.txt2=c.txt2;return a})}function Hg(a,b,c,d){var e=a.storage.graph.clone(),f=b.graph;c=f.getEdge(c);f=f.getNode(c.tail).left;b=Ub(a,b,f);c=Lf(b);for(var f={storage:{graph:e,persistence:new Gh,nextId:a.storage.nextId},render:W},g=b.length,h=0;h<g;)yc(f,b[h],!1),h++;e=H(e,a.render);d=yb(f,e,c,d);a.storage.nextId=f.storage.nextId;
a=d.filter(function(a){return"delete"==a.type});var e=b.filter(function(a){return"insert"==a.type}),k={},l={};a.forEach(function(a){k[a.id]=!0});e.forEach(function(a){l[a.id]=!0});a=b.filter(function(a){return!(a.id in k)});d=d.filter(function(a){return!("delete"==a.type&&a.id in l)});return a.concat(d)}function Ig(a,b,c,d,e){var f=P.showInputBox;f&&f(a,b,c,d,e)}function ka(a){m.readonly||(Tb(m),wg(m,a))}function ph(a,b){return"duration"==b.type?a.getNodeRight(b):null}function qh(a,b){var c=0,c=b.type;
return"branch"===c||"case"===c?a.getNodeUp(b):"select"===c||"address"===c?a.getNodeDown(b):null}function Ka(a){var b=D(m.storage,a),c=b.x+b.w,d=b.y-b.h;"f_line"==b.type&&(c=b.x+20,d=b.y+20);var e=S(b),b="branch"===b.type?function(b){b=xc(e,b);yg(m,a,b)}:function(b){b=xc(e,b);ib(m,a,b)};Ig(n("MES_CHANGE_ITEM_TEXT")+": "+a,e.txt,b,c,d)}function Uc(a){var b=D(m.storage,a),c=b.x+b.w,d=b.y-b.h,e=S(b);Ig(n("MES_CHANGE_ITEM_UPPER")+": "+a,e.txt2,function(b){var c=Utils.copyObject(e);c.txt2=b;ib(m,a,c)},
c,d)}function ng(a){if(!m.readonly){wb=null;ra=[];m.changedNodes={};if(a)if(D(m.storage,a).free)ra=Mf(m,a);else{wb=a;var b=zh();m.canvas.pgraph.startPhysicalDrag(a,b)}else ra=Mf(m,a);m.dragOn=!0}}function Hd(a,b,c){var d=0;a=Object.keys(a);for(var e=a.length;d<e;){var f=a[d],g=b[f];if(null===g||void 0===g)g="";c[f]=g;d++}}function Ke(a,b){x("toBack",[b]);var c=a.storage.free.list,d=[],e=c.indexOf(b);0!=e&&(Ca(d,"free",b,{next:c[0]}),Ca(d,"free",c[e-1],{next:e==c.length-1?"":c[e+1]}),M(a,d,b))}function Je(a,
b){x("toFront",[b]);var c=a.storage.free.list,d=[],e=c.indexOf(b);e!=c.length-1&&(Ca(d,"free",b,{next:""}),0!=e&&Ca(d,"free",c[e-1],{next:c[e+1]}),Ca(d,"free",c[c.length-1],{next:b}),M(a,d,b))}function jc(a){x("to primitive",[]);var b=a.storage.graph,c=a.render;H(b,c);for(var d=ic(b,"header"),e=b.getNodeDown(d),f=b.getNode(e),g=b.getNodeDown(f),h=b.getNode(g),k=U(b,e),l={},m={},f=b.getNodeRight(f),f=U(b,f),q=k,p=f.id,f=[];;){var r=b.getNodeUp(q);f.push(r);if(!q.right)break;q=b.getNodeRight(q);if(q==
p)break;q=b.getNode(q)}var q=b.getNodeDown(h),r=b.getNodeUp(k),k=b.getNode(r),n=b.getNodeUp(k),p=Y(1,c,"end",J(Sa()));m[d.id]=!0;m[g]=!0;l[h.down]=!0;for(var h=0,v=f.length;h<v;)g=f[h],m[g]=!0,g=b.getNode(g),l[g.up]=!0,h++;b.enumerateManhattan(e,m,l);delete m[d.id];e=[];Qb(e,m,l);l=t(a.storage);if(1<f.length){m=[];ga(c,e,l,"end",k.x,k.y+k.h+2*Config.METRE+p.h,p.w,p.h,J(Sa()));C(a,e,d.id,q,"down");c=0;for(d=f.length;c<d;)g=f[c],g=b.getNode(g),h=b.getNodeDown(g),h=b.getNode(h),q=b.getNodeUp(g),k=t(a.storage),
m.push(k),N(e,k,g.x,h.y),C(a,e,q,k,"down"),c++;for(b=1;b<m.length;)E(a,e,m[b-1],m[b],"left"),b++;C(a,e,m[0],l,"down")}else q==r?(ga(c,e,l,"end",k.x,k.y,p.w,p.h,J(Sa())),C(a,e,d.id,l,"down")):(ga(c,e,l,"end",k.x,k.y,p.w,p.h,J(Sa())),C(a,e,d.id,q,"down"),C(a,e,n,l,"down"));M(a,e,null)}function Fd(a){x("to silhouette",[]);if(kc(a,5)){for(var b=a.render,c=H(a.storage.graph,b),d=c.graph,e={},f=[],f={},g=ic(d,"header"),h=g.x+Config.METRE,k=h,l=0,m=c.graph.nodes,q=Object.keys(m),p=q.length;l<p;){var n=m[q[l]];
n.x>g.x&&n.box.left<k&&(k=n.box.left);l++}k<h&&c.moveRight(g.id,k-h,e);k=Y(1,b,"branch",J("branch W"));qa(c,g.down,k.h+Config.METRE/2,e);for(var h=Y(1,b,"end",J(Sa())),l=Yb(d,g.id),y=U(d,g.id),v=g.id,m=c.graph,q=m.getNode(v),p=q.x,n=0,v=m.getVertical(v),A=v.length;n<A;){var z=m.getItem(v[n]);if(!z.isLine&&"beginend"!=z.type&&"end"!=z.type)var K=Drakon.getDuration(m,z),p=Math.min(p,K?K.box.left:z.box.left);n++}p==q.x&&(p=q.x-Config.DEF_ICON_WIDTH);var D=g.y+g.h+Config.METRE,q=D+Config.METRE+k.h,m=
d.getNodeUp(y);c.graph.getNode(m);v=p-Config.METRE;n=g.x+l+k.w+4*Config.METRE;K=dd(c.graph);A=K.bottom+k.h;z=A+Config.METRE+k.h;p=q+4*Config.METRE+k.h+h.h;n<K.right&&(n=K.right);var F=g.x,K=n+2*k.w+4*Config.METRE;I(c,e,f);f=Utils.objectValues(f);m!=g.id&&w(f,g.down);w(f,y.up);ca(f,y.id);var G=t(a.storage),L=t(a.storage),O=t(a.storage),R=t(a.storage),c=t(a.storage),e=t(a.storage),y=t(a.storage),P=t(a.storage),S=t(a.storage),T=t(a.storage),Q=t(a.storage),V=t(a.storage),W=t(a.storage);N(f,G,v,D);N(f,
L,F,D);N(f,O,n,D);N(f,R,K,D);var D=J("Branch 1"),X=J("Branch 2"),Z=J("Branch 3");ga(b,f,c,"branch",F,q,l,k.h,D);ga(b,f,e,"branch",n,q,k.w,k.h,X);ga(b,f,y,"branch",K,q,k.w,k.h,Z);N(f,T,v,z);N(f,Q,F,z);N(f,V,n,z);ga(b,f,P,"address",F,A,l,k.h,X);ga(b,f,S,"address",n,A,k.w,k.h,Z);C(a,f,g.id,L,null);E(a,f,G,L,"rarrow");E(a,f,L,O,null);E(a,f,O,R,null);C(a,f,L,c,null);C(a,f,O,e,null);C(a,f,R,y,null);E(a,f,T,Q,null);E(a,f,Q,V,"sil_floor");C(a,f,G,T,null);C(a,f,P,Q,null);C(a,f,S,V,null);m==g.id?C(a,f,c,P,
"down"):(d=d.getNodeDown(g),C(a,f,c,d,"down"),C(a,f,m,P,"down"));C(a,f,e,S,"down");ga(b,f,W,"end",K,p,h.w,h.h,J(Sa()));C(a,f,y,W,"down");M(a,f,null)}}function Jg(a,b,c,d){var e=b.graph,f={},g=[],h,k=e.getEdge(c),l=e.getNode(d);c=e.getHead(k);var m=e.getTail(k);h=e.getEdge(l.left);h=e.getHead(h);var n=Ma(e,m.id,h.id);n.y>l.y&&R(b,l,n.y,-1E7,f);n=Ma(e,m.id,h.id);n.x>l.x&&(h=n.x-l.x,b.moveRight(d,h,f));e=la(a,e,k,g);k=k.tail;h=b.graph;var n=h.getNode(k),p=null,r=null;n.left&&(p=h.getNodeLeft(n),b.deletePhysicalItem(n.left));
n.up&&b.deletePhysicalItem(n.up);n.right&&(r=h.getNodeRight(n),b.deletePhysicalItem(n.right));n.down&&b.deletePhysicalItem(n.down);b.deletePhysicalItem(k);e&&(e=ma(e,!1,p,r,null),b.insertPhysicalItem(e));b.rebuildCache();e=c.box.bottom+Config.METRE;e>l.y&&R(b,l,e,-1E7,f);c.x!=l.x&&(h=l.x-c.x,b.moveRight(c.id,h,f));eb(b,c.x,c.box.bottom,l.y,f);delete f[m.id];l={};m=a.render;e=Yb(b.graph,c.id);Drakon.setSkewerWidth(m,b,d,e,l);I(b,f,l);g=g.concat(Utils.objectValues(l));a=t(a.storage);vb(g,a,c.id,d);
return g}function Kg(a,b,c,d){var e=b.graph,f={},g={},h,k=e.getEdge(c),l=e.getNode(d),m=e.getTail(k);c=e.getHead(k);h=Q(e,m.id,d);h.y>l.y&&R(b,l,h.y,-1E7,f);h=Q(e,m.id,d);h.x>l.x&&(h=h.x-l.x,b.moveRight(d,h,f));m.x!=l.x&&(h=l.x-m.x,b.moveRight(m.id,h,f));eb(b,m.x,m.y,l.y,f);l=a.render;m=Yb(b.graph,m.id);Drakon.setSkewerWidth(l,b,d,m,g);I(b,f,g);b=Utils.objectValues(g);la(a,e,k,b);a=t(a.storage);vb(b,a,c.id,d);return b}function Lg(a,b){var c=a.transplantSource,d=zc(a,b),e=d.id;if("string"===typeof d.action)console.log("trasplant not implemented: ",
c,e,d.action);else{x("transplant liana",[d.name,c,e]);console.log(d.name);var f=a.storage.graph.getItem(c);f.isLine||(c=f.up);f=H(a.storage.graph,a.render);(c=d.action(a,f,c,e))&&M(a,c,null)}}function Dg(a){a=Utils.copyObject(a)||J("");a.txt=(a.txt||"").trim();a.txt2=(a.txt2||"").trim();return a}function og(a,b,c){if(!m.readonly&&m.dragOn)if(m.render.clearGuides(),wb){var d=m.canvas.pgraph;a=d.physicalDrag(a,b);b=0;for(var e=Object.keys(a.nodes),f=e.length;b<f;){var g=e[b],h=d.graph.getNode(g);m.changedNodes[g]=
!0;pg(m.canvas,g,h.x,h.y);b++}g=0;a=Object.keys(a.edges);for(b=a.length;g<b;){var h=m.canvas,e=m.storage.selection.ids,f=h.render,h=h.graph,k=h.getEdge(a[g]);ea.eraseFromRender(f,k);ea.renderItem(h,f,k,e);g++}g=m.canvas;a=g.sockets;g.sockets={};b=0;e=Object.keys(a);for(f=e.length;b<f;)h=e[b],k=a[h],g.render.deleteItem(h),Wf(g,k),b++;g=m.render;f=d.graph;d=wb;a=f.getItem(d);if(Ve(a)){b=a.y+a.h;e=a.x-a.w;h=a.x+a.w;a=new Wa(a.y-a.h,e,h);b=new Wa(b,e,h);e=0;f=f.nodes;h=Object.keys(f);for(k=h.length;e<
k;){var l=h[e],n=f[l];if(l!=d&&Ve(n)&&Utils.boxesIntersect(c,n.box)){var l=n.y+n.h,q=n.x-n.w,p=n.x+n.w;bb(a,n.y-n.h,q,p);bb(b,l,q,p)}e++}db(g,a);db(g,b)}}else{d=m.canvas.free;e=0;f=ra;for(h=f.length;e<h;)g=f[e],k=d.get(g),pg(m.canvas,g,k.x+a,k.y+b),e++;se&&Kd&&(lb.x+=a,lb.y+=b,W.moveItem(se,lb.x,lb.y));d=m;if(1==ra.length&&(g=d.canvas.free,a=ra[0],b=g.get(a),"f_line"!=b.type)){n=b.y-b.h;l=b.y+b.h;e=b.y;h=b.x-b.w;q=b.x+b.w;k=b.x;b=new Wa(n,h,q);e=new Wa(e,h,q);f=new Wa(l,h,q);h=new Wa(h,n,l);k=new Wa(k,
n,l);n=new Wa(q,n,l);l=0;q=g.list;for(p=q.length;l<p;){var r=q[l];if(r!=a&&(r=g.set[r],"f_line"!=r.type)){var t=r.y-r.h,v=r.y+r.h,w=r.x-r.w,x=r.x+r.w,z=new Utils.Box(w,t,x,v);Utils.boxesIntersect(c,z)&&(bb(b,t,w,x),bb(e,r.y,w,x),bb(f,v,w,x),bb(h,w,t,v),bb(k,r.x,t,v),bb(n,x,t,v))}l++}c=d.render;Jd(c,h);Jd(c,k);Jd(c,n);db(c,b);db(c,e);db(c,f)}}}function Gh(){this.add=function(a){};this.remove=function(a){};this.update=function(a){};this.updateDiagram=function(a){};this.persist=function(){}}var n=Yd,
m=this,ea=Mg,wb=null,ra=[],ta={},lb=null,se=null,Kd=!1,pd=Utils.listToSet("junction vertical horizontal f_line f_more f_label duration loopbegin loopend ctrlStart ctrlEnd pause timer address gdur end f_cloud f_ptr_left f_ptr_right".split(" ")),Nd={};this.readonly=!1;this.render=W;this.canvas=new qe(W);this.storage=new Kc(ld);this.undo=new nd;this.persistence=ld;this.grips=[];var kd="font align padding lineColor lineThickness textColor fillColor secondaryColor shadow lineStyle arrowStart arrowEnd".split(" "),
Hh={tb:!0,primitives:!0};this.renameDiagram=function(a){for(var b=0,c=m.storage.graph.nodes,d=Object.keys(c),e=d.length;;){if(!(b<e)){var f=[];vg(f,a);qb(m,f,null,!1,!0);break}var f=d[b],g=c[f];if("header"==g.role){b=S(g);a=xc(b,a);ib(m,f,a);break}b++}};this.buildTextBoxes=Nc;this.setReadonly=function(a){m.readonly=a};this.findVisualItem=Pf;this.startVisualDrag=ng;this.visualDrag=og;this.endVisualDrag=Bf;this.findSocket=Kf;this.fireSocket=function(a){m.canvas.render.setItemProperty(a,"active",!0);
m.dirty=!0};this.darkenSocket=function(a){m.canvas.render.setItemProperty(a,"active",!1);m.dirty=!0};this.clickSocket=function(a){var b=0;if(F())return null;var c,b=m.canvas.sockets[a];if(ia())"paste"==b.type?(a=Z("mind"))&&wd(b.action.action,b.action.itemId,a):Hb(b.action.action,b.action.itemId,b.action.socketType),Sd();else if(b=b.type,"liana"===b)c=Lg(m,a);else if("insert"===b){c=m;a=zc(c,a);var b=c.storage.graph,d=b.getItem(a.id);sb(d)?V(c,a.id,a.action):d.isLine?d.isVertical?(b=b.getNode(d.tail),
V(c,b.id,a.action)):(b=de(b,d))?V(c,b.id,a.action):V(c,a.id,a.action):V(c,a.id,a.action);c=void 0}else"paste"===b?(c=m,b=0,a=zc(c,a),b=c.storage.graph,kc(c,2)&&(d=b.getItem(a.id),sb(d)?"block"==a.action&&Mb(c,a.id):d.isVertical?(b=b.getNode(d.tail),b.type==a.action&&"case"==b.type&&Rc(c,b.id)):(d=de(b,d))&&d.type==a.action?(b=a.action,"case"===b?Rc(c,d.id):"branch"===b&&Ed(c,d.id)):"duration"==a.action?(a=a.id,(b=Z("duration"))&&Yf(c,a,b)):Mb(c,a.id)),c=void 0):c=null;ub();return c};this.loadDiagram=
function(a){var b=new Kc(m.persistence);b.name=a.name;b.type=a.type;b.background=a.background;b.diaLine=a.diaLine;b.diaLineThickness=a.diaLineThickness;b.font=a.font;b.selection=nc(a.selection);b.version=a.version||0;for(var c=0,d=a.nodes,e=Object.keys(d),f=e.length;c<f;){var g=d[e[c]],g=La(g);g.isLine=!1;b.graph.addItem(g);c++}c=0;d=a.edges;e=Object.keys(d);for(f=e.length;c<f;)g=d[e[c]],g=La(g),g.isLine=!0,b.graph.addItem(g),c++;(a=df(a.free,b.free))&&Utils.throwError(a);a=b.graph.getMaxId();g=b.free.getMaxId();
b.nextId=Math.max(a,g)+1;Gg(m,b);m.render.setDefaultFont(m.storage.font)};this.createDiagram=function(a,b){var c=new Kc(m.persistence);c.type=b;c.version=Config.DIAGRAM_VERSION;Gg(m,c);var c=[],d=m.render,e=Za("font");e||(e=Utils.buildFontString(!1,!1,Config.FONT_SIZE,Config.FONT_FAMILY));m.render.setDefaultFont(e);if("drakon"===b){var f=J(Sa()),g=lf(a),d=Y(2,d,"end",f),f=100+g.h+d.h+200;g.x=300;g.y=100;g.role="header";d.x=300;d.y=f;d.w=Config.MIN_ICON_WIDTH;var f=t(m.storage),h=t(m.storage),k=t(m.storage);
Ya(c,f,g);Ya(c,h,d);vb(c,k,f,h)}else"mind"===b&&(g=m.storage,d=lf(a),d.id="1",d.x=100,d.y=100,d.role="header",Ya(c,d.id,d),g.nextId=2);Fg(c,["background","diaLine"]);Fg(c,["background","diaLineThickness"]);c.push(new z("update","diagrams","diagram",{font:e}));e={origin:null,selection:ua()};m.storage.name=a;$a(m,c,e,!1,!1,new Og("create diagram",[a]));pb(c,!1)};this.diagramToJson=function(){var a=Qf(m);return JSON.stringify(a)};this.autoSizeIcons=function(){x("autoSizeIcons",[]);var a=m;be(a);var b=
pa(a),c=pa(a),d=a.storage.graph,e=Object.keys(d.nodes),f,g=e.length,h=[];for(f=0;f<g;){var k=e[f],l=d.getNode(k);"junction"!=l.type&&(h=Cg(a,k,l.content,h));f++}0!=h.length&&(d=h,$a(a,d,c,!1,!0),Ib(a.undo,b,d,c))};this.hit=function(a){return m.findSocket(a.x,a.y)?!0:m.findVisualItem(a.x,a.y)?!0:!1};this.setCallback=function(a,b){P[a]=b};this.canEditText=function(a,b){var c=m.findVisualItem(a,b);return c&&Qe(c.id)?c.id:null};this.startEditText=Ka;this.startEditTextAt=function(a,b,c){b=D(m.storage,
a);Tc(b)?c>b.y-b.h+2*b.a?Ka(a):Uc(a):Ka(a)};this.measureDiagram=function(){for(var a=H(m.storage.graph,m.render),b=Number.MAX_VALUE,c=-Number.MAX_VALUE,d=Number.MAX_VALUE,e=-Number.MAX_VALUE,e=If(a.graph,b,d,c,e),b=e.left,c=e.top,d=e.right,e=e.bottom,a=0,f=m.storage.free.set,g=Object.keys(f),h=g.length;a<h;){var k=qc(f[g[a]],null),b=Math.min(k.left,b),c=Math.min(k.top,c),d=Math.max(k.right,d),e=Math.max(k.bottom,e);a++}e=new Utils.Box(b,c,d,e);b=Ea(e.left,0);c=Ea(e.right,300);d=Ea(e.top,0);e=Ea(e.bottom,
300);a=Config.METRE;return new Utils.Box(b-a,d-a,c+a,e+a)};this.getIconCount=lc;this.showInsertionSockets=ka;this.performUndo=function(){if(!F()){var a=m.undo;0<a.next&&(a.next--,a=a.steps[a.next],x("undo",a.info),$a(m,a.commands,a.before,!0,!0),pb(a.commands,!0))}};this.performRedo=function(){if(!F()){var a=m.undo;if(!(a.next>=a.steps.length)){var b=a.steps[a.next];x("redo",b.info);$a(m,b.commands,b.after,!1,!0);pb(b.commands,!1);a.next++}}};this.clearUndo=function(){m.undo=new nd};this.toggleSilhouette=
function(){F()||(0<Utils.count(m.storage.graph.items)?re(m.storage.graph)?jc(m):Fd(m):console.log("Not DRAKON"))};this.drawToOtherRender=zf;this.addParameters=function(){if(!F())if(0<Utils.count(m.storage.graph.items)){var a=ic(m.storage.graph,"params");a?(Fa(m,a.id),na(m)):V(m,null,"params")}else console.log("Not DRAKON")};this.drawToOtherRender=zf;this.mouseClick=function(a,b){x("mouseClick",[a,b]);m.dragOn=!1;var c=m.findVisualItem(a,b);x("found vi",[c]);m.dirty=!0;c?c.id&&!m.isSelected(c.id)?
(Tb(m),Fa(m,c.id),na(m)):m.dirty=!1:(Tb(m),na(m));return{mustRedraw:m.dirty}};this.buildBlockMenu=Cd;this.deselect=function(){Tb(m);na(m)};this.blockSelect=function(a){return m.storage.selection.blockSelect(m.storage.graph,m.storage.free,a)?(na(m),!0):!1};this.beginBlockSelect=function(){m.storage.selection=ua();na(m)};this.isSelected=function(a){return a?a in m.storage.selection.ids:!1};this.deleteSelection=function(){F()||(x("delete selection",[]),ia()?fb(function(a,b){hf(b)},function(){},Lb):fb(Ba,
function(){rb(!1,!0)},Lb))};this.redraw=Sd;this.setItemWidth=function(a,b){if(!F()){x("setItemWidth",[a,b]);var c=m,d=c.storage.graph,e=c.render,f=H(d,e),d=d.getNode(a),g={};ia()?Mind.setItemWidth(e,f,a,b,g):Drakon.isWideIcon(d)?Drakon.setSkewerWidth(e,f,a,b,g):Drakon.changeItem(e,f,a,b,d.content,{commands:g});e=Utils.objectValues(g);M(c,e,a)}};this.buildMenuAt=function(a,b){var c=0,d,e=null;d=fc(this);d=Object.keys(d);c=d.length;0===c?(d=(d=Pf(a,b))?d.id:null)?(c=D(m.storage,d),e={type:c.type,content:Utils.copyObject(c.content)},
d=c.free?Ie(m,d):ia()?Oe(m,d):Le(m,d)):d=ae(m,a,b):1===c?(d=d[0])?(c=D(m.storage,d),e={type:c.type,content:Utils.copyObject(c.content)},d=c.free?Ie(m,d):ia()?Oe(m,d):Le(m,d)):d=ae(m,a,b):ia()?d=Ae(m,d):(c=Ad(m),d=1<c.greens.length?Cd():0==c.frees.length?Ae(m,d):ah(m,c.frees,d));return{menu:d,item:e}};this.insertFreeItem=function(a,b,c,d){if(!F()){a=Utils.snapPos(a);b=Utils.snapPos(b);x('Insert free item: "'+c+'"',[{x:a,y:b,type:c}]);var e=m,f=e.storage.free,g=f.list.length,h=e.render,k=t(e.storage),
l=[],n=J(""),q=ta[c];q?q(h,n,k,a,b,l,d):X(h,l,k,c,a,b,Config.FREE_WIDTH,Config.FREE_HEIGHT,n);0!=g&&Ca(l,"free",f.list[g-1],{next:k});M(e,l,k)}};this.setFreeItemSize=function(a,b,c,d,e){if(!F()){x("resize free item",a);var f=m.storage.free,g=f.get(a);if(g){var h={commands:{}};Drakon.changeFreeItem(W,f,a,d,e,g.content,h);d=cc(h.commands,a);d.fields.x=b;d.fields.y=c;b=Utils.objectValues(h.commands);M(m,b,a)}}};this.moveHandle=function(a,b,c,d,e,f){if(!m.readonly){var g=m.render;a=m.canvas.free.get(a);
var h=fc(m);b=ea.moveHandle(a,b,c,d,e,f);Utils.mergeSets(a,b);ea.renderItem(null,g,a,h)}};this.saveHandlePos=function(a){if(!m.readonly){x("save handle pos",[a]);for(var b=m.canvas.free.get(a),c=m.storage.free.get(a),d={},e=0,f=Object.keys(b),g=f.length;e<g;){var h=f[e],k=b[h];h in Hh||c[h]==k&&"content"!=h||(d[h]=k);e++}b=[];a=new z("update","free",a,d);b.push(a);qb(m,b,null,!1,!0)}};this.getDiagramAsItems=function(){var a=Qf(m),b={name:a.name,items:[]};gb(m.storage,"background",b);gb(m.storage,
"diaLine",b);gb(m.storage,"diaLineThickness",b);gb(m.storage,"font",b);Mc(a.nodes,b.items);Mc(a.edges,b.items);Mc(a.free,b.items);return b};this.setBackground=function(a){if(!F()){x("set background",[a]);var b=m,c=[],d={};Jc(a,"background",d);Jc(a,"diaLine",d);Jc(a,"diaLineThickness",d);c.push(new z("update","diagrams","diagram",d));qb(b,c,null,!1,!0)}};this.setFormat=function(a,b){F()||Ic(m,a,function(a){a=(a=a.content)?Utils.copyObject(a):new Utils.Content("","");for(var d=0,e=Object.keys(b),f=
e.length;d<f;){var g=e[d],h=a,k=g,g=b[g],l=Utils.parseFontString(h.font||m.storage.font);"font-italic"===k?(l.italic=g,k=Utils.buildFontString(l.italic,l.bold,l.size,l.family),h.font=k):"font-bold"===k?(l.bold=g,k=Utils.buildFontString(l.italic,l.bold,l.size,l.family),h.font=k):"font-size"===k?(l.size=g,k=Utils.buildFontString(l.italic,l.bold,l.size,l.family),h.font=k):"font-family"===k?(l.family=g,k=Utils.buildFontString(l.italic,l.bold,l.size,l.family),h.font=k):h[k]=g;d++}return a})};this.getFormat=
function(a){for(var b=m,c=!1,d=!1,e=!1,f=!0,g={},h={},k=0,l=a.length;k<l;){var n=D(b.storage,a[k]),q=S(n);n.free||(c=!0);if("comment"==n.type||"insertion"==n.type||"shelf"==n.type)d=!0;n.isLine||"f_line"==n.type?e=!0:f=!1;for(var n=g,p=h,r=0,t=kd,v=t.length;r<v;){var w=t[r],x=n[w],z=q[w];"number"==typeof z||z?p[w]?z!=x&&"fillColor"!=w&&(n[w]=null):(p[w]=!0,n[w]=z):(p[w]=!0,n[w]=null);r++}k++}g.allowTransparent=!c;g.hasLine=e;g.lineOnly=f;g.allowSecondary=d&&1==a.length?!0:!1;return g};this.getItemRect=
function(a){var b=m,c=b.storage.graph,b=D(b.storage,a);return b.isLine?(a=c.getHead(b),c=c.getTail(b),new Utils.Box(a.x,a.y,c.x,c.y)):Utils.boxFromPoint(b.x,b.y,b.w,b.h)};this.getFonts=function(a){var b={};if(a.nodes)for(var c=0,d=a.nodes,e=Object.keys(d),f=e.length;c<f;)xg(d[e[c]],b),c++;if(a.free)for(c=0,d=a.free,e=Object.keys(d),f=e.length;c<f;)xg(d[e[c]],b),c++;a.font?b[a.font]=!0:(c=Utils.buildFontString(!1,!1,Config.FONT_SIZE_1,Config.FONT_FAMILY_1),b[c]=!0,"drakon"==a.type&&(a=Utils.buildFontString(!1,
!0,Config.FONT_SIZE_1,Config.FONT_FAMILY_1),b[a]=!0));return Object.keys(b)};this.getFont=function(){return m.storage.font};this.clearFormat=function(a,b){F()||Ic(m,a,function(a){a=S(a);a=Utils.copyObject(a);for(var b=0,e=kd.length;b<e;)delete a[kd[b]],b++;a.font=Utils.buildFontString(!1,!1,Config.FONT_SIZE,Config.FONT_FAMILY);return a})};this.getSelection=rc;this.copy=function(){ia()?fb(function(a,b){Pb(b,!1)},function(){},function(a,b){Pa(a,b,!0,!1)}):fb(function(a,b){hc(a,b,!1)},function(){rb(!0,
!1)},function(a,b){Pa(a,b,!0,!1)})};this.cut=function(){F()||(ia()?fb(function(a,b){Pb(b,!0)},function(){},function(a,b){Pa(a,b,!0,!0)}):fb(function(a,b){hc(a,b,!0)},function(){rb(!0,!0)},function(a,b){Pa(a,b,!0,!0)}))};this.paste=function(a,b){if(!F()){var c=T();if("free"==c)Bd(m,a,b);else{var d=va(c);d&&("mind"==c?ia()&&ka(d):"drakon"==m.storage.type&&ka(d))}}};this.selectAll=function(){var a=m,b=a.storage,b=Object.keys(b.graph.nodes).concat(b.free.list);Bg(a,b);na(a)};this.findDraggable=Jf;this.setContent=
td;this.setUserSettings=function(a){Nd=Utils.copyObject(a)};this.startEdit=function(){var a=rc();1==a.length&&(a=a[0],Qe(a)&&Ka(a))};this.arrowUp=function(a,b,c){a?F()||vc(0,-1,c):wc(rh,function(a,b){return a.y<b.y})};this.arrowDown=function(a,b,c){a?F()||vc(0,1,c):wc(sh,function(a,b){return a.y>b.y})};this.arrowLeft=function(a,b,c){a?F()||vc(-1,0,c):wc(th,function(a,b){return a.x<b.x})};this.arrowRight=function(a,b,c){a?F()||vc(1,0,c):wc(wh,function(a,b){return a.x>b.x})};this.getItem=function(a){return(a=
D(m.storage,a))?Utils.copyObjectDeep(a):null};this.selectOneItem=function(a){Tb(m);Fa(m,a);na(m)};this.toggleTreeType=function(){!F()&&ia()&&Hb("toggleTree",null,null)};this.getFontsForItems=function(a){for(var b={},c=0,d=a.length;c<d;){var e=D(m.storage,a[c]),e=S(e).font||m.storage.font;b[e]=!0;c++}return Object.keys(b)};var P={},O={};O.leftInnerLine=yb;O.leftInnerLineTs=function(a,b,c,d){var e=b.graph,f={},g={},h=e.getEdge(c),k=e.getTail(h),l=e.getHead(h),h=e.getEdge(d);e.getTail(h);e.removeItem(c);
b.rebuildCache();b.moveDown(l.id,Config.METRE,f);I(b,f,g);b=Utils.objectValues(g);w(b,d);w(b,c);c=fa(a,e,h.head,h.tail,k.y,b);a=t(a.storage);G(b,a,c,k.id,"left");return b};O.leftInnerLineEx=dg;O.leftOuterCorner=ed;O.leftInnerCorner=cg;O.topOuterCorner=Kg;O.topInnerCorner=Jg;O.createCycle=jf;O.onOuterFloor=rg;O.onInnerFloor=qg;O.rightLine=Ag;O.leftOuterLine=sc;O.leftOuterLineTs=function(a,b,c,d){var e=b.graph,f={},g={};qa(b,d,0,f);var h=e.getEdge(c),k=e.getTail(h);e.getHead(h);h=e.getEdge(d);e.getTail(h);
e.removeItem(c);b.rebuildCache();b.moveDown(k.id,Config.METRE,f);I(b,f,g);b=Utils.objectValues(g);w(b,d);w(b,c);c=fa(a,e,h.head,h.tail,k.y,b);a=t(a.storage);G(b,a,c,k.id,"left");return b};O.rightCorner=zg;O.onOuterSilFloor=sg;O.leftOuterCornerSil=eg;O.shortCycleDown=Hg;O.leftOuterCornerTs=function(a,b,c,d){var e=b.graph,f={},g={},h=e.getEdge(c),k=e.getTail(h),l=e.getHead(h),m=e.getNode(d),h=e.getEdge(l.up),n=e.getNodeUpEx(l);e.removeItem(c);b.rebuildCache();b.moveDown(k.id,m.y-k.y,f);I(b,f,g);b=Utils.objectValues(g);
w(b,c);w(b,l.up);w(b,l.down);ca(b,l.id);c=t(a.storage);Aa(b,c,n.id,d,h.role);a=t(a.storage);G(b,a,d,k.id,"left");return b};this.test={canDeleteItem:Qc,insertSimpleItem:ag,insertQuestion:Zf,deleteItem:Ba,setItemText:ib,selectItem:Fa,transplantLiana:Lg,leftInnerLine:yb,leftOuterLine:sc,leftOuterCorner:ed,onOuterFloor:rg,onInnerFloor:qg,leftOuterLine:sc,leftInnerLine:yb,leftInnerLineEx:dg,rightLine:Ag,rightCorner:zg,leftOuterCorner:ed,leftInnerCorner:cg,topOuterCorner:Kg,topInnerCorner:Jg,leftInnerLine:yb,
collapseBolt:bf,expandBolt:ze,createCycle:jf,detectInternalCycle:pc,detectOuterCycle:je,toSilhouette:Fd,toPrimitive:jc,onOuterSilFloor:sg,leftOuterCornerSil:eg,renameBranch:yg,insertBranch:Pd,shortCycleDown:Hg,insertPath:$f,insertItem:Vf,deletePath:Ob,findCycleStartCandidates:Gf,pasteBlock:Mb,toFront:Je,toBack:Ke,setContent:td};(function(){ta={"gdur-left":function(a,b,c,d,e,f){b.right=!1;b.h0x=60;b.h0y=80;b.h1x=60;b.h1y=80;X(a,f,c,"gdur",d,e,Config.DEF_ICON_WIDTH_S,Config.MIN_ICON_HEIGHT,b)},"gdur-right":function(a,
b,c,d,e,f){b.right=!0;b.h0x=60;b.h0y=80;b.h1x=60;b.h1y=80;X(a,f,c,"gdur",d,e,Config.DEF_ICON_WIDTH_S,Config.MIN_ICON_HEIGHT,b)},f_line:function(a,b,c,d,e,f){b.arrowEnd=void 0;X(a,f,c,"f_line",d,e,100,0,b)},f_arrow:function(a,b,c,d,e,f){b.arrowEnd="arrow";X(a,f,c,"f_line",d,e,100,0,b)}};ta.f_label=eh;ta.callout=Xg;ta.f_shelf=nh;ta.f_rounded=mh;ta.f_ptr_right=lh;ta.f_ptr_left=kh;ta.f_more=jh;ta.f_circle=Yg;ta.f_cloud=Zg;ta.f_db=$g})()};
